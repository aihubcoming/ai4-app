import{j as e,o as Pt,p as zt,q as $t,u as ts,W as mr,c as et,r as Bt,e as hs,T as ur,s as hr,t as Ut,O as Ft,v as fr,w as Ot,x as pr,b as xr,y as gr,P as ys,I as yr,d as vr,z as jr,E as wr,l as Ge,F as es}from"./radix-ui-5LtdMfNn.js";import{r as n}from"./vendor-B4gEaEGI.js";import{c as G,u as J,a as ee,s as E,T as jt,b as wt,d as bt,e as Nt,f as V,g as br,X as as,h as ne}from"./main-B34cn-84.js";import{v as Nr,p as st,f as fs}from"./utils-CL64pNYu.js";import{u as kr,C as _r,P as tt,a as at,b as rt,S as be,c as qt,d as Bs,e as Ze,D as vs,f as js,g as ws,h as bs,i as Ns,j as ks,k as ze,l as $e,m as Be,n as ms,o as pe,p as Q,M as Te,q as Us,r as Sr,s as Cr,F as Vt,t as Er,U as Ie,T as nt,v as it,w as Rr}from"./dropdown-menu-B6VQbl0T.js";import{B as _,L as X,b as Gt}from"./label-CgCQUnbP.js";import{C as ss,a as ot,b as lt,c as ct,d as dt}from"./card-6uTiVmyf.js";import{I as ce}from"./input-x-MVjPYt.js";import{B as le}from"./badge-Bd9-fGOs.js";import{M as Fs,H as kt,a as _t}from"./message-circle-CkTvwOFX.js";import{T as _s,a as Ss,b as je,c as we,U as He,H as Ht,S as ps}from"./tabs-DCUF8y04.js";import{C as Wt,S as Yt,a as Kt,b as Qt,c as Xt,d as Se,U as Ne,u as Mr,e as Ar}from"./select-C65-uch7.js";import{L as Le}from"./loader-circle-DuZXIeBk.js";import{L as Ce}from"./lock-CKim2fcJ.js";import{u as Dr}from"./router-CYcLefUh.js";import{S as rs}from"./search-C5rltCw-.js";import{T as mt}from"./textarea-BBZtVFJu.js";import{u as Ir,F as Tr,A as Lr}from"./FileUploadButton-Xz6m5kaz.js";import{A as Ye,a as Ke,b as Cs}from"./avatar-DyKoJ1Aj.js";import"./supabase-B07dSRCg.js";import"./ui-B2rm_Apj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=G("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pr=G("Bitcoin",[["path",{d:"M11.767 19.089c4.924.868 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 18.047m5.908 1.042-.347 1.97m1.563-8.864c4.924.869 6.14-6.025 1.215-6.893m-1.215 6.893-3.94-.694m5.155-6.2L8.29 4.26m5.908 1.042.348-1.97M7.48 20.364l3.126-17.727",key:"yr8idg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zr=G("BookmarkCheck",[["path",{d:"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z",key:"169p4p"}],["path",{d:"m9 10 2 2 4-4",key:"1gnqz4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $r=G("BookmarkX",[["path",{d:"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z",key:"169p4p"}],["path",{d:"m14.5 7.5-5 5",key:"3lb6iw"}],["path",{d:"m9.5 7.5 5 5",key:"ko136h"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=G("Bookmark",[["path",{d:"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z",key:"1fy3hk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=G("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Br=G("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Os=G("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=G("Crown",[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ur=G("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=G("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fr=G("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Or=G("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qr=G("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vr=G("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=G("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gr=G("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=G("Palette",[["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z",key:"12rzf8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hr=G("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wr=G("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yr=G("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kr=G("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qr=G("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ms=G("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xr=G("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jr=G("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ea=G("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zr=G("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const en=G("Video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]),qs="secure_guest_id",xs="secure_guest_name",sn=()=>{const s=Date.now().toString(36),t=Nr().slice(0,8);return`guest-${s}-${t}`},tn=s=>{if(!s||!s.startsWith("guest-"))return!1;const t=s.split("-");if(t.length!==3)return!1;const a=parseInt(t[1],36),c=Date.now(),l=7*24*60*60*1e3;return a>0&&a<=c&&a>c-l},Qe=()=>{let s=localStorage.getItem(qs);return s||(s=sn(),localStorage.setItem(qs,s)),s},an=()=>{let s=localStorage.getItem(xs);return s||(s=`Guest${Math.floor(1e3+Math.random()*9e3)}`,localStorage.setItem(xs,s)),s},rn=s=>{s&&s.trim().length>0&&localStorage.setItem(xs,s.trim())},nn=()=>{localStorage.removeItem(qs),localStorage.removeItem(xs)},on=()=>{const{user:s}=J(),{toast:t}=ee(),[a,c]=n.useState({}),l=async()=>{const{data:d,error:i}=await E.from("message_reactions").select("*");if(i){console.error("Failed to load reactions:",i);return}const m={};d==null||d.forEach(r=>{m[r.message_id]||(m[r.message_id]={}),m[r.message_id][r.emoji]||(m[r.message_id][r.emoji]={count:0,users:[],hasReacted:!1}),m[r.message_id][r.emoji].count++,m[r.message_id][r.emoji].users.push(r.user_id||r.user_name);const u=s?s.id:Qe();r.user_id===u&&(m[r.message_id][r.emoji].hasReacted=!0)}),c(m)};return n.useEffect(()=>{l();const d=E.channel("message-reactions").on("postgres_changes",{event:"*",schema:"public",table:"message_reactions"},()=>{l()}).subscribe();return()=>{E.removeChannel(d)}},[s]),{reactions:a,toggleReaction:async(d,i)=>{var h,x;const m=s?s.id:Qe(),r=((h=s==null?void 0:s.email)==null?void 0:h.split("@")[0])||`Guest-${m.slice(0,8)}`;s||console.log("Guest reaction will persist using secure guest ID");const u=(x=a[d])==null?void 0:x[i],f=(u==null?void 0:u.hasReacted)||!1;if(f){const{error:v}=await E.from("message_reactions").delete().eq("message_id",d).eq("user_id",m).eq("emoji",i);if(v){t({title:"Failed to remove reaction",description:v.message,variant:"destructive"});return}}else{const{error:v}=await E.from("message_reactions").insert({message_id:d,user_id:m,emoji:i,user_name:r});if(v){t({title:"Failed to add reaction",description:v.message,variant:"destructive"});return}}t({title:`${i} ${f?"removed":"added"}`,description:`Your reaction has been ${f?"removed":"added"}.`})}}},ln=()=>{const{user:s}=J(),{toast:t}=ee();return{submitReport:async(l,o,d)=>{if(!s)return t({title:"Login required",description:"Please login to report messages.",variant:"destructive"}),!1;const{error:i}=await E.from("message_reports").insert({message_id:l,reporter_id:s.id,reason:o,details:d||null});return i?(i.code==="23505"?t({title:"Already reported",description:"You have already reported this message.",variant:"destructive"}):t({title:"Failed to submit report",description:i.message,variant:"destructive"}),!1):(t({title:"Report submitted",description:"Thank you for helping keep our community safe."}),!0)},getUserReports:async()=>{if(!s)return[];const{data:l,error:o}=await E.from("message_reports").select("*").eq("reporter_id",s.id).order("created_at",{ascending:!1});return o?(console.error("Failed to load user reports:",o),[]):l||[]}}},cn=()=>{const{user:s}=J(),{toast:t}=ee();return{editMessage:async(o,d)=>{if(!s)return t({title:"Login required",description:"Please login to edit messages.",variant:"destructive"}),!1;if(!d.trim())return t({title:"Invalid content",description:"Message content cannot be empty.",variant:"destructive"}),!1;const{error:i}=await E.from("messages").update({content:d.trim(),edited_at:new Date().toISOString()}).eq("id",o).eq("sender_id",s.id);return i?(t({title:"Failed to edit message",description:i.message,variant:"destructive"}),!1):(t({title:"Message edited",description:"Your message has been updated."}),!0)},deleteMessage:async o=>{if(!s)return t({title:"Login required",description:"Please login to delete messages.",variant:"destructive"}),!1;const{error:d}=await E.from("messages").update({is_deleted:!0,content:"[Message deleted]"}).eq("id",o).eq("sender_id",s.id);return d?(t({title:"Failed to delete message",description:d.message,variant:"destructive"}),!1):(t({title:"Message deleted",description:"Your message has been deleted."}),!0)},getEditHistory:async o=>[]}},dn=()=>{const{user:s}=J(),{toast:t}=ee(),[a,c]=n.useState(null),[l,o]=n.useState({}),[d,i]=n.useState(new Set),m=s?null:`guest-${Date.now()}-${Math.random().toString(36).substring(2)}`,r=n.useCallback(j=>{c(j)},[]),u=n.useCallback(()=>{c(null)},[]),f=n.useCallback(async j=>{if(!(d.has(j)||l[j])){i(y=>new Set(y).add(j));try{const{data:y,error:k}=await E.from("messages").select("*").eq("parent_message_id",j).order("created_at",{ascending:!0});if(k)throw k;const p=(y||[]).map(g=>({id:g.id,content:g.content,created_at:g.created_at,user_id:g.sender_id,guest_id:null,username:g.sender_name,parent_message_id:g.parent_message_id,reply_count:g.reply_count||0,mentions:Array.isArray(g.mentions)?g.mentions:[]}));o(g=>({...g,[j]:p}))}catch(y){console.error("Error loading thread replies:",y),t({title:"Error",description:"Failed to load thread replies",variant:"destructive"})}finally{i(y=>{const k=new Set(y);return k.delete(j),k})}}},[d,l,t]),h=n.useCallback(async(j,y)=>{var k,p;if(!j.trim())return!1;try{const g={content:j.trim(),parent_message_id:y,sender_id:(s==null?void 0:s.id)||null,sender_name:((k=s==null?void 0:s.user_metadata)==null?void 0:k.name)||(s==null?void 0:s.email)||`Guest ${m==null?void 0:m.slice(-4)}`},{data:b,error:N}=await E.from("messages").insert([g]).select().single();if(N)throw N;const C={id:b.id,content:b.content,created_at:b.created_at,user_id:b.sender_id,guest_id:null,username:b.sender_name,parent_message_id:b.parent_message_id,reply_count:0,mentions:Array.isArray(b.mentions)?b.mentions:[]};return o(I=>({...I,[y]:[...I[y]||[],C]})),await E.from("messages").update({reply_count:(((p=l[y])==null?void 0:p.length)||0)+1}).eq("id",y),c(null),!0}catch(g){return console.error("Error sending reply:",g),t({title:"Error",description:"Failed to send reply",variant:"destructive"}),!1}},[s,m,l,t]),x=n.useCallback(j=>l[j]||[],[l]),v=n.useCallback(j=>d.has(j),[d]);return{replyingTo:a,startReply:r,cancelReply:u,sendReply:h,loadThreadReplies:f,getThreadReplies:x,isLoadingThread:v}},sa={ALLOWED_TAGS:["b","i","em","strong","code","a"],ALLOWED_ATTR:["href","target","rel","class"],FORBID_TAGS:["script","style","iframe","object","embed","form","input"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"],KEEP_CONTENT:!1,RETURN_DOM:!1,RETURN_DOM_FRAGMENT:!1},mn=[/admin/i,/moderator/i,/mod/i,/support/i,/staff/i,/system/i,/bot/i,/service/i,/official/i,/verified/i,/\b(fuck|shit|damn|hell|ass|bitch|bastard|crap)\b/i,/^(.)\1{2,}$/,/^\d+$/],un=s=>!s||typeof s!="string"?"":st.sanitize(s.trim(),sa).replace(/javascript:/gi,"").replace(/data:(?!image\/[a-z]+;base64,)/gi,"").replace(/vbscript:/gi,"").replace(/<script[\s\S]*?<\/script>/gi,"").trim(),ta=s=>{if(!s||typeof s!="string")return{valid:!1,sanitized:"",error:"Name is required"};let t=st.sanitize(s.trim(),{ALLOWED_TAGS:[],ALLOWED_ATTR:[],KEEP_CONTENT:!0}).trim();if(t.length<3)return{valid:!1,sanitized:t,error:"Name must be at least 3 characters"};if(t.length>20)return{valid:!1,sanitized:t,error:"Name must be 20 characters or less"};if(!/^[a-zA-Z0-9_-]+$/.test(t))return{valid:!1,sanitized:t,error:"Name can only contain letters, numbers, underscore, and hyphen"};for(const a of mn)if(a.test(t))return{valid:!1,sanitized:t,error:"This name is not allowed"};return{valid:!0,sanitized:t}},Ct=new Map,hn=10,fn=60*1e3,pn=s=>{const t=Date.now(),a=Ct.get(s);return!a||t-a.lastReset>fn?(Ct.set(s,{count:1,lastReset:t}),!1):a.count>=hn?!0:(a.count++,!1)},xn=s=>{if(!s||typeof s!="string")return"";try{const t=new URL(s);if(t.protocol==="http:"||t.protocol==="https:")return t.toString()}catch{}return""},gn=s=>[/\b(spam|scam|phishing|hack|virus|malware)\b/i,/\b(bitcoin|crypto|investment|money)\s+(guaranteed|fast|easy|instant)\b/i,/\b(click\s+here|visit\s+now|buy\s+now|limited\s+time)\b/i,/(\b\w+\.\w{2,}\b.*){3,}/].some(a=>a.test(s)),yn=s=>{if(!s||typeof s!="string")return"";const t=st.sanitize(s,{...sa,KEEP_CONTENT:!0}).replace(/javascript:/gi,"").replace(/data:(?!image\/[a-z]+;base64,)/gi,"").replace(/vbscript:/gi,"").replace(/<script[\s\S]*?<\/script>/gi,""),a=/(https?:\/\/[^\s<>"']+[^\s<>"'.,;!?])/gi;return t.replace(a,c=>{const l=xn(c);return l?`<a href="${l}" target="_blank" rel="noopener noreferrer" class="text-primary hover:text-primary/80 underline transition-colors">${c}</a>`:c})},aa=()=>{const{toast:s}=ee(),{moderateContent:t}=kr(),{user:a}=J();return{validateAndSanitizeMessage:async(o,d)=>{if(!o||typeof o!="string")return s({title:"Invalid message",description:"Message content is required.",variant:"destructive"}),{isValid:!1,sanitized:""};const i=o.trim();if(i.length===0)return s({title:"Empty message",description:"Please enter a message to send.",variant:"destructive"}),{isValid:!1,sanitized:""};if(i.length>1e3)return s({title:"Message too long",description:"Message must be 1000 characters or less.",variant:"destructive"}),{isValid:!1,sanitized:""};const m=Qe();if(pn(m))return s({title:"Rate limit exceeded",description:"Please wait before sending another message.",variant:"destructive"}),{isValid:!1,sanitized:""};const r=un(i);if(!r)return s({title:"Invalid content",description:"Message contains prohibited content.",variant:"destructive"}),{isValid:!1,sanitized:""};if(gn(r))return s({title:"Inappropriate content",description:"Message contains content that is not allowed.",variant:"destructive"}),{isValid:!1,sanitized:""};try{const u=await t(r,(a==null?void 0:a.id)||null,d);if(!u.allowed){const f=u.violations.length>0?u.violations[0]:"Content not allowed";return s({title:"Message blocked",description:u.autoBlocked?`Message automatically blocked: ${f}`:"Message contains inappropriate content.",variant:"destructive"}),{isValid:!1,sanitized:""}}u.flagged&&u.allowed&&s({title:"Content flagged",description:"Your message has been sent but flagged for review.",variant:"default"})}catch(u){console.error("Moderation check failed:",u)}return{isValid:!0,sanitized:r}},logSecurityEvent:(o,d)=>{console.warn(`Security Event [${o}]:`,{timestamp:new Date().toISOString(),guestId:Qe(),...d})}}},vn=()=>{const{toast:s}=ee(),t=n.useRef(Date.now()),a=n.useRef(!1);return n.useEffect(()=>{const l=Qe();tn(l)||(console.warn("Invalid guest session detected"),localStorage.removeItem("secure_guest_id"),localStorage.removeItem("secure_guest_name"));const o=30*60*1e3,d=25*60*1e3,i=()=>{const h=Date.now()-t.current;h>d&&!a.current&&(a.current=!0,s({title:"Session expiring soon",description:"Your session will expire in 5 minutes due to inactivity.",variant:"default"})),h>o&&(s({title:"Session expired",description:"Your session has expired. Please refresh the page.",variant:"destructive"}),localStorage.removeItem("secure_guest_id"),localStorage.removeItem("secure_guest_name"))},m=()=>{t.current=Date.now(),a.current=!1},r=["mousedown","mousemove","keypress","scroll","touchstart"];r.forEach(f=>{document.addEventListener(f,m,!0)});const u=setInterval(i,6e4);return()=>{r.forEach(f=>{document.removeEventListener(f,m,!0)}),clearInterval(u)}},[s]),{logSecurityEvent:(l,o={})=>{const d={timestamp:new Date().toISOString(),event:l,guestId:Qe(),userAgent:navigator.userAgent,url:window.location.href,...o};console.warn("Security Event:",d)}}},jn=({onConfirm:s})=>{const[t,a]=n.useState(!1),c=()=>{t&&(localStorage.setItem("ageVerified","true"),s())};return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:e.jsxs(ss,{className:"w-full max-w-md neon-bg neon-border",children:[e.jsxs(ot,{className:"text-center",children:[e.jsx(lt,{className:"text-2xl font-bold neon-glow",children:"Age Verification"}),e.jsx(ct,{className:"text-muted-foreground",children:"Please confirm that you are 18 years of age or older to enter IMAIET."})]}),e.jsxs(dt,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_r,{id:"age-confirm",checked:t,onCheckedChange:l=>a(l)}),e.jsx("label",{htmlFor:"age-confirm",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"I am 18 years or older"})]}),e.jsx(_,{onClick:c,disabled:!t,className:"w-full",size:"lg",children:"Enter Chat"})]})]})})},ht=()=>{const{user:s}=J(),[t,a]=n.useState([]),[c,l]=n.useState(null),[o,d]=n.useState(!0);return n.useEffect(()=>{if(!s){d(!1);return}const m=E.channel("user_presence");return m.on("presence",{event:"sync"},()=>{const r=m.presenceState(),u=Object.values(r).flat().filter(f=>f&&typeof f=="object"&&"user_id"in f);a(u),d(!1)}).subscribe(async r=>{r==="SUBSCRIBED"&&await m.track({user_id:s.id,status:"online",last_activity:new Date().toISOString()})}),()=>{E.removeChannel(m)}},[s]),{onlineUsers:t,userStatus:c,isLoading:o,updateUserStatus:async(m,r)=>{if(!s)return;await E.channel("user_presence").track({user_id:s.id,status:m,custom_message:r,last_activity:new Date().toISOString()}),l({user_id:s.id,status:m,custom_message:r,last_activity:new Date().toISOString()})},getOnlineCount:()=>t.filter(m=>m.status==="online").length,getUserStatus:m=>t.find(r=>r.user_id===m)}},ra=()=>{const[s,t]=n.useState("default"),[a,c]=n.useState([]),[l,o]=n.useState(!0),[d,i]=n.useState({mentions:!0,dms:!0,reactions:!0,announcements:!0}),{toast:m}=ee(),{user:r}=J(),u=a.filter(p=>!p.is_read).length,f=s==="granted";n.useEffect(()=>{"Notification"in window&&t(Notification.permission)},[]);const h=n.useCallback(async()=>{if(!r){c([]),o(!1);return}try{const{data:p,error:g}=await E.from("notifications").select("*").eq("user_id",r.id).order("created_at",{ascending:!1}).limit(50);if(g)throw g;c((p==null?void 0:p.map(b=>({id:b.id,type:b.type,title:b.title,message:b.message,is_read:b.is_read??!1,created_at:b.created_at,data:b.data})))||[])}catch(p){console.error("Error fetching notifications:",p)}finally{o(!1)}},[r]);n.useEffect(()=>{h()},[h]),n.useEffect(()=>{if(!r)return;const p=E.channel("notifications-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${r.id}`},g=>{const b=g.new;c(N=>[{id:b.id,type:b.type,title:b.title,message:b.message,is_read:b.is_read??!1,created_at:b.created_at,data:b.data},...N]),s==="granted"&&v(b.title,{body:b.message||void 0})}).subscribe();return()=>{E.removeChannel(p)}},[r,s]);const x=n.useCallback(async()=>{if(!("Notification"in window))return m({title:"Not supported",description:"This browser does not support desktop notifications.",variant:"destructive"}),!1;try{const p=await Notification.requestPermission();return t(p),p==="granted"?(m({title:"Notifications enabled",description:"You will now receive notifications for mentions."}),!0):(m({title:"Notifications blocked",description:"Please enable notifications in your browser settings if you want to receive alerts.",variant:"destructive"}),!1)}catch(p){return console.error("Error requesting notification permission:",p),!1}},[m]),v=n.useCallback((p,g)=>{if(s==="granted")try{new Notification(p,g)}catch(b){console.error("Notification error:",b)}},[s]),j=n.useCallback(async p=>{if(r)try{const{error:g}=await E.from("notifications").update({is_read:!0}).eq("id",p).eq("user_id",r.id);if(g)throw g;c(b=>b.map(N=>N.id===p?{...N,is_read:!0}:N))}catch(g){console.error("Error marking notification as read:",g)}},[r]),y=n.useCallback(async()=>{if(r)try{const{error:p}=await E.from("notifications").update({is_read:!0}).eq("user_id",r.id).eq("is_read",!1);if(p)throw p;c(g=>g.map(b=>({...b,is_read:!0})))}catch(p){console.error("Error marking all notifications as read:",p)}},[r]),k=n.useCallback(p=>{i(p),localStorage.setItem("notification_preferences",JSON.stringify(p))},[]);return n.useEffect(()=>{const p=localStorage.getItem("notification_preferences");if(p)try{i(JSON.parse(p))}catch{}},[]),{permission:s,notifications:a,unreadCount:u,isLoading:l,preferences:d,hasPermission:f,requestPermission:x,requestNotificationPermission:x,sendNotification:v,markAsRead:j,markAllAsRead:y,updatePreferences:k}},na=()=>{const{user:s}=J();ee();const[t,a]=n.useState(0),[c,l]=n.useState([]),[o,d]=n.useState(!0),i=async()=>{if(!s){a(0),l([]),d(!1);return}try{const{data:r}=await E.rpc("get_unread_message_count",{p_user_id:s.id}),{data:u}=await E.rpc("get_unread_conversations",{p_user_id:s.id});a(typeof r=="number"?r:0),l(Array.isArray(u)?u:[])}catch(r){console.error("Error fetching unread messages:",r)}finally{d(!1)}},m=async r=>{if(s)try{await E.rpc("mark_messages_as_read",{p_sender_id:r,p_user_id:s.id}),await i()}catch(u){console.error("Error marking messages as read:",u)}};return n.useEffect(()=>{i()},[s]),n.useEffect(()=>{if(!s)return;const r=E.channel(`unread-${s.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"private_messages",filter:`receiver_id=eq.${s.id}`},()=>i()).subscribe();return()=>{E.removeChannel(r)}},[s]),{unreadCount:t,unreadConversations:c,markMessagesAsRead:m,loading:o,refreshUnreadMessages:i}},wn=({onOpenPrivateChat:s})=>{const{unreadCount:t,unreadConversations:a,markMessagesAsRead:c,loading:l}=na();if(l||t===0)return e.jsxs(_,{variant:"outline",size:"sm",className:"relative",children:[e.jsx(Fs,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline ml-2",children:"Messages"})]});const o=async(d,i)=>{await c(d),s(d,i)};return e.jsxs(tt,{children:[e.jsx(at,{asChild:!0,children:e.jsxs(_,{variant:"outline",size:"sm",className:"relative",children:[e.jsx(Fs,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline ml-2",children:"Messages"}),t>0&&e.jsx(le,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 min-w-[20px] flex items-center justify-center text-xs px-1",children:t>99?"99+":t})]})}),e.jsxs(rt,{className:"w-80 p-0",align:"end",children:[e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("h3",{className:"font-semibold text-sm",children:["Unread Messages (",t,")"]})}),e.jsx(be,{className:"max-h-80",children:e.jsx("div",{className:"p-2",children:a.map(d=>e.jsx(_,{variant:"ghost",className:"w-full justify-start p-3 h-auto mb-1",onClick:()=>o(d.sender_id,d.sender_name),children:e.jsx("div",{className:"flex flex-col items-start w-full",children:e.jsxs("div",{className:"flex items-center justify-between w-full mb-1",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:d.sender_name}),e.jsxs(le,{variant:"secondary",className:"text-xs",children:[d.unread_count," unread"]})]})})},d.sender_id))})})]})]})},bn=()=>{const{notifications:s,unreadCount:t,isLoading:a,preferences:c,markAsRead:l,markAllAsRead:o,updatePreferences:d,requestNotificationPermission:i,hasPermission:m}=ra(),[r,u]=n.useState(!1),f=(j,y)=>{y||l(j)},h=j=>{switch(j){case"mention":return"üí¨";case"dm":return"üì©";case"reaction":return"‚ù§Ô∏è";case"achievement":return"üèÜ";case"announcement":return"üì¢";default:return"üîî"}},x=s.filter(j=>!j.is_read),v=s.filter(j=>j.is_read);return e.jsxs(tt,{open:r,onOpenChange:u,children:[e.jsx(at,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"icon",className:"relative",children:[e.jsx(us,{className:"h-5 w-5"}),t>0&&e.jsx(le,{variant:"destructive",className:"absolute -top-1 -right-1 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs",children:t>99?"99+":t})]})}),e.jsx(rt,{className:"w-96 p-0",align:"end",children:e.jsxs(_s,{defaultValue:"notifications",className:"w-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"font-semibold",children:"Notifications"}),e.jsxs("div",{className:"flex items-center gap-2",children:[t>0&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:o,className:"h-8 px-2",children:[e.jsx(Br,{className:"h-4 w-4 mr-1"}),"Mark all read"]}),e.jsxs(Ss,{className:"grid w-auto grid-cols-2",children:[e.jsxs(je,{value:"notifications",className:"text-xs",children:[e.jsx(us,{className:"h-3 w-3 mr-1"}),"Notifications"]}),e.jsxs(je,{value:"settings",className:"text-xs",children:[e.jsx(qt,{className:"h-3 w-3 mr-1"}),"Settings"]})]})]})]}),e.jsx(we,{value:"notifications",className:"m-0",children:e.jsx(be,{className:"h-96",children:a?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"Loading notifications..."}):s.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(us,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No notifications yet"}),e.jsx("p",{className:"text-sm",children:"You'll see new notifications here"})]}):e.jsxs(e.Fragment,{children:[x.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-3 text-sm font-medium text-muted-foreground bg-muted/50",children:["New (",x.length,")"]}),x.map(j=>e.jsx("div",{className:"p-3 hover:bg-muted/50 cursor-pointer border-l-4 border-l-primary bg-primary/5",onClick:()=>f(j.id,j.is_read),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-lg",children:h(j.type)}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium",children:j.title}),e.jsx(_,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:y=>{y.stopPropagation(),l(j.id)},children:e.jsx(Wt,{className:"h-3 w-3"})})]}),j.message&&e.jsx("p",{className:"text-sm text-muted-foreground",children:j.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:fs(new Date(j.created_at),{addSuffix:!0})})]})]})},j.id))]}),v.length>0&&e.jsxs(e.Fragment,{children:[x.length>0&&e.jsx(Bs,{}),e.jsx("div",{className:"p-3 text-sm font-medium text-muted-foreground bg-muted/30",children:"Earlier"}),v.slice(0,10).map(j=>e.jsx("div",{className:"p-3 hover:bg-muted/30 cursor-pointer opacity-70",onClick:()=>f(j.id,j.is_read),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-lg opacity-60",children:h(j.type)}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-sm",children:j.title}),j.message&&e.jsx("p",{className:"text-sm text-muted-foreground",children:j.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:fs(new Date(j.created_at),{addSuffix:!0})})]})]})},j.id))]})]})})}),e.jsx(we,{value:"settings",className:"m-0",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-3",children:"Browser Notifications"}),m?e.jsx("p",{className:"text-sm text-green-600",children:"‚úì Browser notifications enabled"}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable browser notifications to get notified even when IMAIET is not active."}),e.jsx(_,{onClick:i,size:"sm",className:"w-full",children:"Enable Browser Notifications"})]})]}),e.jsx(Bs,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-3",children:"Notification Types"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{htmlFor:"mentions",className:"text-sm",children:"Mentions"}),e.jsx(Ze,{id:"mentions",checked:c.mentions,onCheckedChange:j=>d({...c,mentions:j})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{htmlFor:"dms",className:"text-sm",children:"Direct Messages"}),e.jsx(Ze,{id:"dms",checked:c.dms,onCheckedChange:j=>d({...c,dms:j})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{htmlFor:"reactions",className:"text-sm",children:"Reactions"}),e.jsx(Ze,{id:"reactions",checked:c.reactions,onCheckedChange:j=>d({...c,reactions:j})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{htmlFor:"announcements",className:"text-sm",children:"Announcements"}),e.jsx(Ze,{id:"announcements",checked:c.announcements,onCheckedChange:j=>d({...c,announcements:j})})]})]})]})]})})]})})]})},Ls=[{value:"online",label:"Online",color:"bg-green-500",description:"Available and active"},{value:"away",label:"Away",color:"bg-yellow-500",description:"Away from keyboard"},{value:"busy",label:"Busy",color:"bg-red-500",description:"Do not disturb"},{value:"offline",label:"Offline",color:"bg-gray-400",description:"Not available"}],Nn=({isOpen:s,onClose:t})=>{var h,x;const{userStatus:a,updateUserStatus:c}=ht(),[l,o]=n.useState("online"),[d,i]=n.useState(""),[m,r]=n.useState(!1);n.useEffect(()=>{a&&(o(a.status),i(a.custom_message||""))},[a]);const u=async()=>{r(!0);try{await c(l,d||void 0),t()}catch(v){console.error("Error updating status:",v)}finally{r(!1)}},f=()=>{i("")};return e.jsx(vs,{open:s,onOpenChange:t,children:e.jsxs(js,{className:"sm:max-w-[425px]",children:[e.jsxs(ws,{children:[e.jsx(bs,{children:"Update Your Status"}),e.jsx(Ns,{children:"Let others know your availability and what you're up to."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"status",children:"Status"}),e.jsxs(Yt,{value:l,onValueChange:v=>o(v),children:[e.jsx(Kt,{children:e.jsx(Qt,{})}),e.jsx(Xt,{children:Ls.map(v=>e.jsx(Se,{value:v.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${v.color}`}),e.jsx("span",{children:v.label}),e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:v.description})]})},v.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"message",children:"Custom Message (Optional)"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{id:"message",placeholder:"What's on your mind?",value:d,onChange:v=>i(v.target.value),maxLength:100}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[d.length,"/100 characters"]}),d&&e.jsx(_,{variant:"ghost",size:"sm",onClick:f,children:"Clear"})]})]})]}),d&&e.jsxs("div",{className:"p-3 bg-muted rounded-lg",children:[e.jsx(X,{className:"text-sm text-muted-foreground",children:"Preview:"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${(h=Ls.find(v=>v.value===l))==null?void 0:h.color}`}),e.jsx(le,{variant:"outline",className:"text-sm",children:(x=Ls.find(v=>v.value===l))==null?void 0:x.label}),e.jsxs("span",{className:"text-sm",children:['"',d,'"']})]})]})]}),e.jsxs(ks,{children:[e.jsx(_,{variant:"outline",onClick:t,children:"Cancel"}),e.jsx(_,{onClick:u,disabled:m,children:m?"Updating...":"Update Status"})]})]})})},kn=({userId:s,userName:t,size:a="sm",showText:c=!1})=>{const{getUserStatus:l}=ht(),o=l(s);if(!o)return null;const d=x=>{switch(x){case"online":return"bg-green-500";case"away":return"bg-yellow-500";case"busy":return"bg-red-500";case"offline":default:return"bg-gray-400"}},i=x=>{switch(x){case"online":return"Online";case"away":return"Away";case"busy":return"Busy";case"offline":default:return"Offline"}},m={sm:"w-2 h-2",md:"w-3 h-3",lg:"w-4 h-4"}[a],r=()=>e.jsx("div",{className:`${m} rounded-full ${d(o.status)} border-2 border-background`}),u=i(o.status),f=o.custom_message,h=e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:t||"User"}),e.jsx("div",{className:"text-sm",children:u}),f&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:['"',f,'"']})]});return c?e.jsx(jt,{children:e.jsxs(wt,{children:[e.jsx(bt,{asChild:!0,children:e.jsxs(le,{variant:"outline",className:"flex items-center gap-1.5",children:[e.jsx(r,{}),e.jsx("span",{className:"text-xs",children:u}),f&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["- ",f]})]})}),e.jsx(Nt,{children:h})]})}):e.jsx(jt,{children:e.jsxs(wt,{children:[e.jsx(bt,{asChild:!0,children:e.jsx("div",{className:"relative inline-block",children:e.jsx(r,{})})}),e.jsx(Nt,{children:h})]})})},As=()=>{const[s,t]=n.useState({isOnline:!0,lastChecked:new Date,responseTime:void 0}),[a,c]=n.useState(!1),{toast:l}=ee(),o=async()=>{c(!0);try{const m=Date.now(),{data:r,error:u}=await E.functions.invoke("chat-bot",{body:{message:"ping",username:"status-check",mentions:[]}}),f=Date.now()-m,h=!u&&r!==null;return t(x=>({...x,isOnline:h,lastChecked:new Date,responseTime:h?f:void 0})),h}catch(m){return console.error("Bot status check error:",m),t(r=>({...r,isOnline:!1,lastChecked:new Date,responseTime:void 0})),!1}finally{c(!1)}},d=async(m,r,u=[],f)=>{try{console.log("üöÄ Sending message to bot via edge function:",{message:m,username:r,mentions:u,channelId:f});const{data:h,error:x}=await E.functions.invoke("chat-bot",{body:{message:m,username:r,mentions:u,channel_id:f||null}});return x?(console.error("‚ùå Edge function error:",x),l({title:"Bot error",description:"Failed to send message to the AI bot. Please try again.",variant:"destructive"}),t(v=>({...v,isOnline:!1,lastChecked:new Date})),{success:!1,error:"Edge function error"}):(console.log("‚úÖ Bot response received:",h),(h==null?void 0:h.success)===!1?(console.log("‚ö†Ô∏è Bot returned error with message:",h.error),h.botResponse?(console.log("üîÑ Displaying bot error message to user:",h.botResponse),{success:!0,botResponse:h.botResponse,savedToDatabase:!1}):(console.log("‚ùå No bot response, showing error toast"),l({title:"Bot unavailable",description:h.error||"Bot is having issues right now.",variant:"destructive"}),{success:!1,error:h.error||"Bot error"})):(t(v=>({...v,isOnline:!0,lastChecked:new Date})),{success:!0,botResponse:(h==null?void 0:h.botResponse)||"I received your message!",messageId:h==null?void 0:h.messageId,savedToDatabase:(h==null?void 0:h.savedToDatabase)||!1}))}catch(h){return console.error("‚ùå Failed to send message to bot:",h),l({title:"Connection error",description:"Could not connect to the AI bot. Please check your connection.",variant:"destructive"}),t(x=>({...x,isOnline:!1,lastChecked:new Date})),{success:!1,error:"Connection failed"}}},i=(m,r=[])=>{const u=m.toLowerCase().trim().startsWith("@bot"),f=r==null?void 0:r.some(h=>{var x,v;return((x=h.username)==null?void 0:x.toLowerCase())==="bot"||((v=h.display_name)==null?void 0:v.toLowerCase())==="bot"});return u||f};return n.useEffect(()=>{o()},[]),{botStatus:s,isCheckingStatus:a,checkBotStatus:o,sendMessageToBot:d,isBotMention:i}},_n=()=>{const[s,t]=n.useState(!1),{sendMessageToBot:a,botStatus:c}=As(),{toast:l}=ee(),o=async()=>{var d;t(!0);try{console.log("üß™ Testing bot integration...");const i=await a("@bot Hello, this is a test","TestUser",[{user_id:"bot",username:"bot",display_name:"bot",start_index:0,end_index:4}]);console.log("üß™ Bot test result:",i),i.success?l({title:"Bot test successful! ‚úÖ",description:`Bot responded: ${(d=i.botResponse)==null?void 0:d.substring(0,100)}...`,variant:"default"}):l({title:"Bot test failed ‚ùå",description:i.error||"Unknown error",variant:"destructive"})}catch(i){console.error("üß™ Bot test error:",i),l({title:"Bot test error ‚ùå",description:"Failed to test bot integration",variant:"destructive"})}finally{t(!1)}};return e.jsxs(_,{onClick:o,disabled:s,variant:"outline",size:"sm",className:"gap-2",children:[s?e.jsx(Le,{className:"w-4 h-4 animate-spin"}):e.jsx(ut,{className:"w-4 h-4"}),"Test Bot",e.jsx("span",{className:`ml-2 w-2 h-2 rounded-full ${c.isOnline?"bg-green-500":"bg-red-500"}`})]})},ns=()=>{const{user:s}=J(),[t,a]=n.useState([]),[c,l]=n.useState(null),[o,d]=n.useState([]),[i,m]=n.useState(!0),r=n.useCallback(async()=>{if(!s){a([]),m(!1);return}try{const{data:y,error:k}=await E.from("channels").select("*").eq("created_by",s.id).in("room_type",["private","group"]);if(k)throw k;const{data:p,error:g}=await E.from("group_members").select("channel_id").eq("user_id",s.id);if(g)throw g;const b=(p==null?void 0:p.map(q=>q.channel_id))||[];let N=[];if(b.length>0){const{data:q,error:Y}=await E.from("channels").select("*").in("id",b).in("room_type",["private","group"]);if(Y)throw Y;N=q||[]}const U=[...y||[],...N].reduce((q,Y)=>(q.find(ie=>ie.id===Y.id)||q.push(Y),q),[]).filter(q=>q.is_temporary&&q.expires_at?new Date(q.expires_at)>new Date:!0);a(U),m(!1)}catch(y){console.error("Error fetching rooms:",y),m(!1)}},[s]);return n.useEffect(()=>{r()},[r]),n.useEffect(()=>{if(!c)return;(async()=>{try{const{data:k,error:p}=await E.from("group_members").select("*").eq("channel_id",c.id);if(p)throw p;d(k||[])}catch(k){console.error("Error fetching room members:",k)}})()},[c]),{rooms:t,currentRoom:c,roomMembers:o,isLoading:i,setCurrentRoom:l,createRoom:async(y,k,p="private",g=!1,b=60)=>{if(!s)return V.error("You must be logged in to create a room"),null;try{const N=g?new Date(Date.now()+b*60*1e3).toISOString():null,{data:C,error:I}=await E.from("channels").insert({name:y.trim(),description:k==null?void 0:k.trim(),type:"private",room_type:p,is_temporary:g,expires_at:N,created_by:s.id,status:"active"}).select().single();if(I)throw I;const{error:U}=await E.from("group_members").insert({channel_id:C.id,user_id:s.id,role:"admin"});return U&&console.error("Error adding creator as member:",U),a(q=>[...q,C]),V.success(`${g?"Temporary room":"Room"} "${y}" created!`),C}catch(N){return console.error("Error creating room:",N),V.error("Failed to create room"),null}},deleteRoom:async y=>{if(!s)return!1;try{const k=t.find(g=>g.id===y);if(!k||k.created_by!==s.id)return V.error("Only the room creator can delete this room"),!1;const{error:p}=await E.from("channels").delete().eq("id",y);if(p)throw p;return a(g=>g.filter(b=>b.id!==y)),(c==null?void 0:c.id)===y&&l(null),V.success("Room deleted successfully!"),!0}catch(k){return console.error("Error deleting room:",k),V.error("Failed to delete room"),!1}},addMember:async(y,k)=>{if(!s)return!1;try{const{error:p}=await E.from("group_members").insert({channel_id:y,user_id:k,role:"member",invited_by:s.id});if(p)throw p;return V.success("Member added successfully!"),!0}catch(p){return console.error("Error adding member:",p),p.code==="23505"?V.error("User is already a member"):V.error("Failed to add member"),!1}},removeMember:async(y,k)=>{if(!s)return!1;try{const{error:p}=await E.from("group_members").delete().eq("channel_id",y).eq("user_id",k);if(p)throw p;return d(g=>g.filter(b=>!(b.channel_id===y&&b.user_id===k))),V.success("Member removed successfully!"),!0}catch(p){return console.error("Error removing member:",p),V.error("Failed to remove member"),!1}},leaveRoom:async y=>{if(!s)return!1;try{const{error:k}=await E.from("group_members").delete().eq("channel_id",y).eq("user_id",s.id);if(k)throw k;return a(p=>p.filter(g=>g.id!==y)),(c==null?void 0:c.id)===y&&l(null),V.success("Left room successfully!"),!0}catch(k){return console.error("Error leaving room:",k),V.error("Failed to leave room"),!1}},isRoomAdmin:y=>{if(!s)return!1;const k=t.find(g=>g.id===y);if((k==null?void 0:k.created_by)===s.id)return!0;const p=o.find(g=>g.channel_id===y&&g.user_id===s.id);return(p==null?void 0:p.role)==="admin"},refreshRooms:r}},Sn=({currentRoom:s,onRoomSelect:t})=>{const{rooms:a,isLoading:c}=ns(),l=a.filter(i=>i.room_type==="private"),o=a.filter(i=>i.room_type==="group"),d=i=>{switch(i){case"private":return e.jsx(Ce,{className:"h-4 w-4 mr-2"});case"group":return e.jsx(Ne,{className:"h-4 w-4 mr-2"});default:return e.jsx(Te,{className:"h-4 w-4 mr-2"})}};return e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,children:e.jsx(_,{variant:"outline",size:"sm",className:"gap-2",children:s?e.jsxs(e.Fragment,{children:[d(s.room_type),e.jsx("span",{className:"max-w-[150px] truncate",children:s.name})]}):e.jsxs(e.Fragment,{children:[e.jsx(kt,{className:"h-4 w-4"}),e.jsx("span",{children:"Public Chat"})]})})}),e.jsxs(Be,{align:"end",className:"w-56",children:[e.jsx(ms,{children:"Switch Room"}),e.jsx(pe,{}),e.jsxs(Q,{onClick:()=>t(null),children:[e.jsx(kt,{className:"h-4 w-4 mr-2"}),"Public Chat",!s&&e.jsx("span",{className:"ml-auto text-xs",children:"‚úì"})]}),l.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{}),e.jsx(ms,{className:"text-xs text-muted-foreground",children:"Private Rooms"}),l.map(i=>e.jsxs(Q,{onClick:()=>t(i),children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"truncate",children:i.name}),(s==null?void 0:s.id)===i.id&&e.jsx("span",{className:"ml-auto text-xs",children:"‚úì"})]},i.id))]}),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{}),e.jsx(ms,{className:"text-xs text-muted-foreground",children:"Group Rooms"}),o.map(i=>e.jsxs(Q,{onClick:()=>t(i),children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"truncate",children:i.name}),(s==null?void 0:s.id)===i.id&&e.jsx("span",{className:"ml-auto text-xs",children:"‚úì"})]},i.id))]}),a.length===0&&!c&&e.jsx(Q,{disabled:!0,children:e.jsx("span",{className:"text-muted-foreground text-sm",children:"No rooms available"})})]})]})},Cn=({searchQuery:s,onSearchChange:t,onLoginClick:a,onDonateClick:c,onOpenPrivateChat:l,onShowBookmarks:o,onExportChat:d,currentRoom:i,onRoomSelect:m})=>{var b,N,C,I;const{cycleTheme:r,theme:u}=br(),{user:f}=J(),h=Dr(),{getOnlineCount:x}=ht(),{permission:v,requestPermission:j}=ra(),[y,k]=n.useState(!1),p=async()=>{await E.auth.signOut()},g=()=>{switch(u){case"theme-dark":return"üåô";case"theme-light":return"‚òÄÔ∏è";case"theme-neon":return"‚ö°";default:return"üé®"}};return e.jsxs("header",{className:"chat-header border-b border-border p-3 md:p-4 flex flex-col md:flex-row items-center gap-3 md:gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between w-full md:w-auto",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-lg md:text-xl font-bold neon-glow",children:"IMAIET"}),e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(Us,{className:"h-2 w-2 fill-green-500 text-green-500"}),e.jsxs("span",{children:[x()," online"]})]})]}),e.jsx(_,{variant:"outline",size:"sm",onClick:r,title:`Current theme: ${u.replace("theme-","")}`,className:"md:hidden",children:e.jsx(St,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1 w-full md:max-w-md relative",children:e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{type:"text",placeholder:"Search messages...",value:s,onChange:U=>t(U.target.value),className:"pl-10 pr-10 chat-input h-10 text-base"}),s&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>t(""),className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-8 w-8 p-0",children:e.jsx(as,{className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 w-full md:w-auto justify-center md:justify-end",children:[f&&m&&e.jsx(Sn,{currentRoom:i||null,onRoomSelect:m}),v==="default"&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:j,className:"min-h-[40px] px-3",title:"Enable browser notifications",children:[e.jsx(us,{className:"w-4 h-4"}),e.jsx("span",{className:"sr-only",children:"Enable Notifications"})]}),f&&e.jsxs(e.Fragment,{children:[e.jsx(bn,{}),o&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:o,className:"min-h-[40px] px-3",title:"View bookmarked messages",children:[e.jsx(Jt,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Bookmarks"})]}),e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"sm",className:"gap-2 px-2 min-h-[40px]",children:[e.jsx(kn,{userId:f.id,userName:f.email}),e.jsx("span",{className:"hidden sm:inline-block max-w-[100px] truncate",children:((C=(N=(b=f.identities)==null?void 0:b[0])==null?void 0:N.identity_data)==null?void 0:C.full_name)||((I=f.email)==null?void 0:I.split("@")[0])})]})}),e.jsxs(Be,{align:"end",className:"w-56",children:[e.jsx(ms,{children:"My Account"}),e.jsxs(Q,{onClick:()=>h("/profile"),children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Profile Settings"})]}),e.jsxs(Q,{onClick:()=>k(!0),children:[e.jsx(Us,{className:"mr-2 h-4 w-4 fill-current"}),e.jsx("span",{children:"Set Status"})]}),e.jsxs(Q,{onClick:()=>h("/achievements"),children:[e.jsx(qt,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Achievements"})]}),e.jsx(pe,{}),d&&e.jsxs(e.Fragment,{children:[e.jsxs(Q,{onClick:d,children:[e.jsx(Sr,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Export Chat"})]}),e.jsx(pe,{})]}),e.jsxs(Q,{onClick:p,className:"text-destructive focus:text-destructive",children:[e.jsx(Zt,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Log out"})]})]})]}),e.jsx(wn,{onOpenPrivateChat:l})]}),!f&&e.jsxs(_,{variant:"outline",onClick:a,className:"min-h-[40px] px-4",children:[e.jsx(Vr,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Log In"})]}),e.jsxs(_,{variant:"outline",onClick:r,title:`Current theme: ${u.replace("theme-","")}`,className:"hidden md:flex min-h-[40px]",children:[e.jsx(St,{className:"w-4 h-4 mr-2"}),g()]}),e.jsx(_n,{}),e.jsxs(_,{variant:"outline",onClick:c,className:"min-h-[40px] px-4",children:[e.jsx(Ht,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Donate"})]})]}),e.jsx(Nn,{isOpen:y,onClose:()=>k(!1)})]})},En=({users:s,guestName:t,onUserClick:a,onGuestNameChange:c,onMentionUser:l})=>{const{user:o}=J(),{toast:d}=ee(),{botStatus:i}=As(),[m,r]=n.useState(!1),[u,f]=n.useState(t),h=()=>{const y=ta(u);if(!y.valid){d({title:"Invalid name",description:y.error,variant:"destructive"});return}c(y.sanitized),r(!1),d({title:"Name updated",description:"Your display name has been updated successfully."})},x=()=>{f(t),r(!1)},v=(y,k,p,g=!1)=>g?e.jsx(ut,{className:"w-3 h-3 text-primary"}):k?e.jsx(Es,{className:"w-3 h-3 text-warning"}):p?e.jsx(He,{className:"w-3 h-3 text-primary"}):e.jsx(He,{className:"w-3 h-3 text-muted-foreground"}),j=(y,k,p,g=!1)=>g?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{variant:"secondary",className:"text-xs px-1.5 py-0.5 bg-primary/10 text-primary border-primary/20",children:"AI Bot"}),e.jsx("div",{className:`w-2 h-2 rounded-full ${i.isOnline?"bg-green-500":"bg-red-500"}`,title:i.isOnline?"Bot is online":"Bot is offline"})]}):k?e.jsx(le,{variant:"secondary",className:"text-xs px-1.5 py-0.5 bg-warning/10 text-warning border-warning/20",children:"Premium"}):p?e.jsx(le,{variant:"outline",className:"text-xs px-1.5 py-0.5",children:"You"}):e.jsx(le,{variant:"secondary",className:"text-xs px-1.5 py-0.5 bg-muted/50",children:"Guest"});return e.jsxs("aside",{className:"w-full md:w-64 chat-sidebar border-r border-border flex flex-col h-full",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(ps,{className:"w-4 h-4 text-primary"}),e.jsx("h3",{className:"font-semibold text-sm",children:"Online Users"}),e.jsx(le,{variant:"outline",className:"text-xs",children:s.length+1})]}),!o&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground font-medium",children:"Your Name:"}),m?e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{value:u,onChange:y=>f(y.target.value),className:"h-8 text-sm",placeholder:"Enter your name",maxLength:20,autoFocus:!0,onKeyDown:y=>{y.key==="Enter"&&h(),y.key==="Escape"&&x()}}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(_,{size:"sm",onClick:h,className:"h-6 px-2 text-xs",children:e.jsx(Wt,{className:"w-3 h-3"})}),e.jsx(_,{size:"sm",variant:"outline",onClick:x,className:"h-6 px-2 text-xs",children:e.jsx(as,{className:"w-3 h-3"})})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"3-20 characters, letters/numbers only"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[e.jsx(He,{className:"w-3 h-3 text-primary flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:t})]}),e.jsx(_,{size:"sm",variant:"ghost",onClick:()=>r(!0),className:"h-6 w-6 p-0 hover:bg-accent",children:e.jsx(Wr,{className:"w-3 h-3"})})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("div",{className:`
              flex items-center gap-2 p-2 rounded-md transition-colors cursor-pointer group
              ${i.isOnline?"hover:bg-accent/50 border border-primary/10":"opacity-60 cursor-not-allowed bg-muted/30"}
            `,onClick:()=>{i.isOnline?l("bot"):d({title:"Bot unavailable",description:"The AI bot is currently offline. Please try again later.",variant:"destructive"})},title:i.isOnline?"Click to mention the AI bot":"Bot is currently offline",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[v("bot",!1,!1,!0),e.jsx("span",{className:"text-sm font-medium text-primary",children:"@bot"}),!i.isOnline&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"(offline)"})]}),e.jsx("div",{className:"flex items-center gap-1",children:j("bot",!1,!1,!0)})]}),s.map(({name:y,isMember:k,key:p})=>{var b;const g=o?((b=o==null?void 0:o.user_metadata)==null?void 0:b.name)===y||(o==null?void 0:o.email)===y:y===t;return e.jsxs("div",{className:`
                  flex items-center gap-2 p-2 rounded-md transition-colors cursor-pointer group
                  ${g?"bg-primary/10 border border-primary/20":"hover:bg-accent/50"}
                  ${g?"":"hover:bg-accent"}
                `,onClick:()=>!g&&l(y),children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[v(y,k,g),e.jsx("span",{className:`text-sm truncate ${g?"font-medium text-primary":""}`,title:y,children:g?"You":y})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[j(y,k,g),k&&e.jsx("div",{className:"w-2 h-2 bg-warning rounded-full",title:"Premium Member"})]})]},p)})]})}),e.jsx("div",{className:"p-3 border-t border-border bg-muted/30",children:e.jsxs("div",{className:"text-xs text-muted-foreground text-center",children:[e.jsx(ps,{className:"w-3 h-3 inline mr-1"}),"Secure Guest Session"]})})]})},Rn=["‚ù§Ô∏è","üëç","üëé","üòÇ","üò¢","üòÆ","üò°","üéâ","üî•","üíØ","üëè","‚ú®","üí™","üôå","üëå","ü§ù","üíù","üåü","‚ö°","üíé"],Et=({messageId:s,reactions:t={},onReact:a,compact:c=!1})=>{const[l,o]=n.useState(!1),d=m=>{a(m),o(!1)},i=Object.values(t).reduce((m,r)=>m+r.count,0);return e.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[Object.entries(t).map(([m,r])=>r.count>0&&e.jsxs(_,{variant:r.hasReacted?"default":"outline",size:"sm",onClick:()=>a(m),className:`
              h-6 px-2 text-xs transition-all duration-200 hover:scale-105
              ${r.hasReacted?"bg-primary/20 border-primary":"hover:bg-muted"}
              ${c?"min-w-[2rem]":"min-w-[2.5rem]"}`,children:[e.jsx("span",{className:"mr-1",children:m}),!c&&e.jsx("span",{className:"text-xs",children:r.count})]},m)),e.jsxs(tt,{open:l,onOpenChange:o,children:[e.jsx(at,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-muted",title:"Add reaction",children:e.jsx(Xr,{className:"w-3 h-3"})})}),e.jsxs(rt,{className:"w-80 p-3",align:"start",children:[e.jsx("div",{className:"grid grid-cols-10 gap-1",children:Rn.map(m=>e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>d(m),className:"h-8 w-8 p-0 hover:bg-muted transition-colors duration-150",title:`React with ${m}`,children:e.jsx("span",{className:"text-lg",children:m})},m))}),i>0&&e.jsx("div",{className:"mt-3 pt-3 border-t border-border",children:e.jsxs("p",{className:"text-xs text-muted-foreground text-center",children:[i," reaction",i!==1?"s":""," on this message"]})})]})]})]})};var Mn=Symbol("radix.slottable");function An(s){const t=({children:a})=>e.jsx(e.Fragment,{children:a});return t.displayName=`${s}.Slottable`,t.__radixId=Mn,t}var ia="AlertDialog",[Dn]=et(ia,[Pt]),ke=Pt(),oa=s=>{const{__scopeAlertDialog:t,...a}=s,c=ke(t);return e.jsx(zt,{...c,...a,modal:!0})};oa.displayName=ia;var In="AlertDialogTrigger",Tn=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,l=ke(a);return e.jsx(fr,{...l,...c,ref:t})});Tn.displayName=In;var Ln="AlertDialogPortal",la=s=>{const{__scopeAlertDialog:t,...a}=s,c=ke(t);return e.jsx($t,{...c,...a})};la.displayName=Ln;var Pn="AlertDialogOverlay",ca=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,l=ke(a);return e.jsx(Ft,{...l,...c,ref:t})});ca.displayName=Pn;var We="AlertDialogContent",[zn,$n]=Dn(We),Bn=An("AlertDialogContent"),da=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,children:c,...l}=s,o=ke(a),d=n.useRef(null),i=ts(t,d),m=n.useRef(null);return e.jsx(mr,{contentName:We,titleName:ma,docsSlug:"alert-dialog",children:e.jsx(zn,{scope:a,cancelRef:m,children:e.jsxs(Bt,{role:"alertdialog",...o,...l,ref:i,onOpenAutoFocus:hs(l.onOpenAutoFocus,r=>{var u;r.preventDefault(),(u=m.current)==null||u.focus({preventScroll:!0})}),onPointerDownOutside:r=>r.preventDefault(),onInteractOutside:r=>r.preventDefault(),children:[e.jsx(Bn,{children:c}),e.jsx(Fn,{contentRef:d})]})})})});da.displayName=We;var ma="AlertDialogTitle",ua=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,l=ke(a);return e.jsx(ur,{...l,...c,ref:t})});ua.displayName=ma;var ha="AlertDialogDescription",fa=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,l=ke(a);return e.jsx(hr,{...l,...c,ref:t})});fa.displayName=ha;var Un="AlertDialogAction",pa=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,l=ke(a);return e.jsx(Ut,{...l,...c,ref:t})});pa.displayName=Un;var xa="AlertDialogCancel",ga=n.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,{cancelRef:l}=$n(xa,a),o=ke(a),d=ts(t,l);return e.jsx(Ut,{...o,...c,ref:d})});ga.displayName=xa;var Fn=({contentRef:s})=>{const t=`\`${We}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${We}\` by passing a \`${ha}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${We}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var c;document.getElementById((c=s.current)==null?void 0:c.getAttribute("aria-describedby"))||console.warn(t)},[t,s]),null},On=oa,qn=la,ya=ca,va=da,ja=pa,wa=ga,ba=ua,Na=fa;const Rt=On,Vn=qn,ka=n.forwardRef(({className:s,...t},a)=>e.jsx(ya,{className:ne("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));ka.displayName=ya.displayName;const Vs=n.forwardRef(({className:s,...t},a)=>e.jsxs(Vn,{children:[e.jsx(ka,{}),e.jsx(va,{ref:a,className:ne("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...t})]}));Vs.displayName=va.displayName;const Gs=({className:s,...t})=>e.jsx("div",{className:ne("flex flex-col space-y-2 text-center sm:text-left",s),...t});Gs.displayName="AlertDialogHeader";const Hs=({className:s,...t})=>e.jsx("div",{className:ne("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...t});Hs.displayName="AlertDialogFooter";const Ws=n.forwardRef(({className:s,...t},a)=>e.jsx(ba,{ref:a,className:ne("text-lg font-semibold",s),...t}));Ws.displayName=ba.displayName;const Ys=n.forwardRef(({className:s,...t},a)=>e.jsx(Na,{ref:a,className:ne("text-sm text-muted-foreground",s),...t}));Ys.displayName=Na.displayName;const Ks=n.forwardRef(({className:s,...t},a)=>e.jsx(ja,{ref:a,className:ne(Gt(),s),...t}));Ks.displayName=ja.displayName;const Qs=n.forwardRef(({className:s,...t},a)=>e.jsx(wa,{ref:a,className:ne(Gt({variant:"outline"}),"mt-2 sm:mt-0",s),...t}));Qs.displayName=wa.displayName;var ft="Radio",[Gn,_a]=et(ft),[Hn,Wn]=Gn(ft),Sa=n.forwardRef((s,t)=>{const{__scopeRadio:a,name:c,checked:l=!1,required:o,disabled:d,value:i="on",onCheck:m,form:r,...u}=s,[f,h]=n.useState(null),x=ts(t,y=>h(y)),v=n.useRef(!1),j=f?r||!!f.closest("form"):!0;return e.jsxs(Hn,{scope:a,checked:l,disabled:d,children:[e.jsx(ys.button,{type:"button",role:"radio","aria-checked":l,"data-state":Ma(l),"data-disabled":d?"":void 0,disabled:d,value:i,...u,ref:x,onClick:hs(s.onClick,y=>{l||m==null||m(),j&&(v.current=y.isPropagationStopped(),v.current||y.stopPropagation())})}),j&&e.jsx(Ra,{control:f,bubbles:!v.current,name:c,value:i,checked:l,required:o,disabled:d,form:r,style:{transform:"translateX(-100%)"}})]})});Sa.displayName=ft;var Ca="RadioIndicator",Ea=n.forwardRef((s,t)=>{const{__scopeRadio:a,forceMount:c,...l}=s,o=Wn(Ca,a);return e.jsx(vr,{present:c||o.checked,children:e.jsx(ys.span,{"data-state":Ma(o.checked),"data-disabled":o.disabled?"":void 0,...l,ref:t})})});Ea.displayName=Ca;var Yn="RadioBubbleInput",Ra=n.forwardRef(({__scopeRadio:s,control:t,checked:a,bubbles:c=!0,...l},o)=>{const d=n.useRef(null),i=ts(d,o),m=Mr(a),r=jr(t);return n.useEffect(()=>{const u=d.current;if(!u)return;const f=window.HTMLInputElement.prototype,x=Object.getOwnPropertyDescriptor(f,"checked").set;if(m!==a&&x){const v=new Event("click",{bubbles:c});x.call(u,a),u.dispatchEvent(v)}},[m,a,c]),e.jsx(ys.input,{type:"radio","aria-hidden":!0,defaultChecked:a,...l,tabIndex:-1,ref:i,style:{...l.style,...r,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Ra.displayName=Yn;function Ma(s){return s?"checked":"unchecked"}var Kn=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Ds="RadioGroup",[Qn]=et(Ds,[Ot,_a]),Aa=Ot(),Da=_a(),[Xn,Jn]=Qn(Ds),Ia=n.forwardRef((s,t)=>{const{__scopeRadioGroup:a,name:c,defaultValue:l,value:o,required:d=!1,disabled:i=!1,orientation:m,dir:r,loop:u=!0,onValueChange:f,...h}=s,x=Aa(a),v=pr(r),[j,y]=xr({prop:o,defaultProp:l??null,onChange:f,caller:Ds});return e.jsx(Xn,{scope:a,name:c,required:d,disabled:i,value:j,onValueChange:y,children:e.jsx(gr,{asChild:!0,...x,orientation:m,dir:v,loop:u,children:e.jsx(ys.div,{role:"radiogroup","aria-required":d,"aria-orientation":m,"data-disabled":i?"":void 0,dir:v,...h,ref:t})})})});Ia.displayName=Ds;var Ta="RadioGroupItem",La=n.forwardRef((s,t)=>{const{__scopeRadioGroup:a,disabled:c,...l}=s,o=Jn(Ta,a),d=o.disabled||c,i=Aa(a),m=Da(a),r=n.useRef(null),u=ts(t,r),f=o.value===l.value,h=n.useRef(!1);return n.useEffect(()=>{const x=j=>{Kn.includes(j.key)&&(h.current=!0)},v=()=>h.current=!1;return document.addEventListener("keydown",x),document.addEventListener("keyup",v),()=>{document.removeEventListener("keydown",x),document.removeEventListener("keyup",v)}},[]),e.jsx(yr,{asChild:!0,...i,focusable:!d,active:f,children:e.jsx(Sa,{disabled:d,required:o.required,checked:f,...m,...l,name:o.name,ref:u,onCheck:()=>o.onValueChange(l.value),onKeyDown:hs(x=>{x.key==="Enter"&&x.preventDefault()}),onFocus:hs(l.onFocus,()=>{var x;h.current&&((x=r.current)==null||x.click())})})})});La.displayName=Ta;var Zn="RadioGroupIndicator",Pa=n.forwardRef((s,t)=>{const{__scopeRadioGroup:a,...c}=s,l=Da(a);return e.jsx(Ea,{...l,...c,ref:t})});Pa.displayName=Zn;var za=Ia,$a=La,ei=Pa;const pt=n.forwardRef(({className:s,...t},a)=>e.jsx(za,{className:ne("grid gap-2",s),...t,ref:a}));pt.displayName=za.displayName;const gs=n.forwardRef(({className:s,...t},a)=>e.jsx($a,{ref:a,className:ne("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(ei,{className:"flex items-center justify-center",children:e.jsx(Us,{className:"h-2.5 w-2.5 fill-current text-current"})})}));gs.displayName=$a.displayName;const Ba=()=>{const{user:s}=J(),{toast:t}=ee(),[a,c]=n.useState([]),[l,o]=n.useState(new Set),[d,i]=n.useState(!1);n.useEffect(()=>{if(!s){c([]),o(new Set);return}m()},[s]);const m=async()=>{if(s){i(!0);try{const{data:x,error:v}=await E.from("bookmarks").select("id, message_id, created_at").eq("user_id",s.id).order("created_at",{ascending:!1});if(v)throw v;const j=(x||[]).map(p=>p.message_id);let y=[];if(j.length>0){const{data:p}=await E.from("messages").select("*").in("id",j);y=p||[]}const k=(x||[]).map(p=>({...p,message:y.find(g=>g.id===p.message_id)||null}));c(k),o(new Set(k.map(p=>p.message_id)))}catch(x){console.error("Error loading bookmarks:",x)}finally{i(!1)}}},r=async x=>{if(!s)return t({title:"Login required",description:"Please log in to bookmark messages.",variant:"destructive"}),!1;if(l.has(x))return!0;try{const{error:v}=await E.from("bookmarks").insert({user_id:s.id,message_id:x});if(v)throw v;return o(j=>new Set(j).add(x)),t({title:"Message bookmarked"}),m(),!0}catch(v){return console.error("Error adding bookmark:",v),!1}},u=async x=>{if(!s)return!1;try{const{error:v}=await E.from("bookmarks").delete().eq("user_id",s.id).eq("message_id",x);if(v)throw v;return o(j=>{const y=new Set(j);return y.delete(x),y}),c(j=>j.filter(y=>y.message_id!==x)),t({title:"Bookmark removed"}),!0}catch{return!1}};return{bookmarks:a,isLoading:d,addBookmark:r,removeBookmark:u,toggleBookmark:async x=>l.has(x)?await u(x):await r(x),isBookmarked:x=>l.has(x),bookmarkCount:a.length,loadBookmarks:m}},si=({messageId:s,className:t,size:a="sm",variant:c="ghost",showLabel:l=!1})=>{const{isBookmarked:o,toggleBookmark:d}=Ba(),[i,m]=n.useState(!1),r=o(s),u=async()=>{m(!0),await d(s),m(!1)};return e.jsxs(_,{variant:c,size:a,onClick:u,disabled:i,className:ne("transition-all duration-200",r&&c==="ghost"&&"text-yellow-600 hover:text-yellow-700",t),"aria-label":r?"Remove bookmark":"Bookmark message",children:[r?e.jsx(zr,{className:"w-4 h-4"}):e.jsx(Jt,{className:"w-4 h-4"}),l&&e.jsx("span",{className:"ml-1",children:r?"Bookmarked":"Bookmark"})]})},ti=[{value:"spam",label:"Spam or unwanted content"},{value:"harassment",label:"Harassment or bullying"},{value:"hate",label:"Hate speech or discrimination"},{value:"violence",label:"Violence or threats"},{value:"inappropriate",label:"Inappropriate content"},{value:"other",label:"Other"}],ai=({messageId:s,isOwn:t,content:a,senderName:c,senderId:l,onReport:o,onEdit:d,onDelete:i,onReply:m,onPrivateMessage:r})=>{const{toast:u}=ee(),[f,h]=n.useState(!1),[x,v]=n.useState(!1),[j,y]=n.useState(""),[k,p]=n.useState(""),g=()=>{navigator.clipboard.writeText(a),u({title:"Copied!",description:"Message content copied to clipboard."})},b=()=>{j&&(o==null||o(j,k),h(!1),y(""),p(""),u({title:"Report submitted",description:"Thank you for helping keep our community safe."}))},N=()=>{i==null||i(),v(!1),u({title:"Message deleted",description:"Your message has been removed."})};return e.jsxs(e.Fragment,{children:[e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx(Fr,{className:"w-3 h-3"})})}),e.jsxs(Be,{align:"start",className:"w-48",children:[m&&e.jsxs(e.Fragment,{children:[e.jsxs(Q,{onClick:m,children:[e.jsx(Qr,{className:"w-4 h-4 mr-2"}),"Reply"]}),e.jsx(pe,{})]}),e.jsxs(Q,{onClick:g,children:[e.jsx(Os,{className:"w-4 h-4 mr-2"}),"Copy message"]}),e.jsx("div",{className:"px-2 py-1",children:e.jsx(si,{messageId:s,variant:"ghost",size:"sm",showLabel:!0,className:"w-full justify-start h-8"})}),t&&d&&e.jsxs(Q,{onClick:()=>d(a),children:[e.jsx(Cr,{className:"w-4 h-4 mr-2"}),"Edit message"]}),t&&i&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{}),e.jsxs(Q,{onClick:()=>v(!0),className:"text-destructive focus:text-destructive",children:[e.jsx(ea,{className:"w-4 h-4 mr-2"}),"Delete message"]})]}),!t&&r&&l&&c&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{}),e.jsxs(Q,{onClick:()=>r(l,c),children:[e.jsx(Fs,{className:"w-4 h-4 mr-2"}),"Send private message"]})]}),!t&&o&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{}),e.jsxs(Q,{onClick:()=>h(!0),className:"text-destructive focus:text-destructive",children:[e.jsx(Vt,{className:"w-4 h-4 mr-2"}),"Report message"]})]})]})]}),e.jsx(Rt,{open:f,onOpenChange:h,children:e.jsxs(Vs,{className:"max-w-md",children:[e.jsxs(Gs,{children:[e.jsx(Ws,{children:"Report Message"}),e.jsx(Ys,{children:"Help us understand what's wrong with this message. Your report will be reviewed by our moderation team."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(X,{className:"text-sm font-medium",children:"Why are you reporting this message?"}),e.jsx(pt,{value:j,onValueChange:y,className:"mt-2",children:ti.map(C=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gs,{value:C.value,id:C.value}),e.jsx(X,{htmlFor:C.value,className:"text-sm font-normal",children:C.label})]},C.value))})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"report-details",className:"text-sm font-medium",children:"Additional details (optional)"}),e.jsx(mt,{id:"report-details",value:k,onChange:C=>p(C.target.value),placeholder:"Provide more context if needed...",className:"mt-1 resize-none",rows:3})]})]}),e.jsxs(Hs,{children:[e.jsx(Qs,{children:"Cancel"}),e.jsx(Ks,{onClick:b,disabled:!j,className:"bg-destructive hover:bg-destructive/90",children:"Submit Report"})]})]})}),e.jsx(Rt,{open:x,onOpenChange:v,children:e.jsxs(Vs,{children:[e.jsxs(Gs,{children:[e.jsx(Ws,{children:"Delete Message"}),e.jsx(Ys,{children:"Are you sure you want to delete this message? This action cannot be undone."})]}),e.jsxs(Hs,{children:[e.jsx(Qs,{children:"Cancel"}),e.jsx(Ks,{onClick:N,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})})]})};function ri(s){if(!s)return[];const t=[];let a=0;const c=[{type:"codeBlock",regex:/```(\w+)?\n?([\s\S]*?)```/g},{type:"inlineCode",regex:/`([^`]+)`/g},{type:"bold",regex:/\*\*([^*]+)\*\*/g},{type:"italic",regex:/\*([^*]+)\*/g},{type:"underline",regex:/__([^_]+)__/g},{type:"strikethrough",regex:/~~([^~]+)~~/g},{type:"link",regex:/\[([^\]]+)\]\(([^)]+)\)/g},{type:"blockquote",regex:/^> (.+)$/gm},{type:"listItem",regex:/^[-*+] (.+)$/gm}],l=[];for(const{type:i,regex:m}of c){m.lastIndex=0;let r;for(;(r=m.exec(s))!==null;)l.push({type:i,match:r,start:r.index,end:r.index+r[0].length})}l.sort((i,m)=>i.start-m.start);const o=[];let d=0;for(const i of l)i.start>=d&&(o.push(i),d=i.end);for(const{type:i,match:m,start:r,end:u}of o){if(r>a){const f=s.slice(a,r);f&&t.push({type:"text",content:f})}switch(i){case"bold":t.push({type:"bold",content:m[1]});break;case"italic":t.push({type:"italic",content:m[1]});break;case"underline":t.push({type:"underline",content:m[1]});break;case"strikethrough":t.push({type:"strikethrough",content:m[1]});break;case"inlineCode":t.push({type:"inline-code",content:m[1]});break;case"codeBlock":t.push({type:"code-block",content:m[2]||m[1],language:m[1]&&m[2]?m[1]:void 0});break;case"blockquote":t.push({type:"blockquote",content:m[1]});break;case"link":t.push({type:"link",content:m[1],url:m[2]});break;case"listItem":t.push({type:"list-item",content:m[1]});break}a=u}if(a<s.length){const i=s.slice(a);i&&t.push({type:"text",content:i})}return t.length>0?t:[{type:"text",content:s}]}const ni={smileys:[{emoji:"üòÄ",name:"grinning",aliases:["grinning"],category:"smileys",keywords:["happy","smile","joy"]},{emoji:"üòÉ",name:"smiley",aliases:["smiley"],category:"smileys",keywords:["happy","smile","joy"]},{emoji:"üòÑ",name:"smile",aliases:["smile"],category:"smileys",keywords:["happy","joy","laugh"]},{emoji:"üòÅ",name:"grin",aliases:["grin"],category:"smileys",keywords:["happy","smile"]},{emoji:"üòÜ",name:"laughing",aliases:["laughing","satisfied"],category:"smileys",keywords:["happy","laugh","joy"]},{emoji:"üòÖ",name:"sweat_smile",aliases:["sweat_smile"],category:"smileys",keywords:["happy","sweat","nervous"]},{emoji:"ü§£",name:"rofl",aliases:["rofl","rolling_on_floor_laughing"],category:"smileys",keywords:["laugh","lol","funny"]},{emoji:"üòÇ",name:"joy",aliases:["joy"],category:"smileys",keywords:["happy","laugh","tears"]},{emoji:"üôÇ",name:"slightly_smiling_face",aliases:["slightly_smiling_face"],category:"smileys",keywords:["smile","happy"]},{emoji:"üôÉ",name:"upside_down_face",aliases:["upside_down_face"],category:"smileys",keywords:["silly","sarcasm"]},{emoji:"üòâ",name:"wink",aliases:["wink"],category:"smileys",keywords:["flirt","wink"]},{emoji:"üòä",name:"blush",aliases:["blush"],category:"smileys",keywords:["happy","blush","pleased"]},{emoji:"üòá",name:"innocent",aliases:["innocent"],category:"smileys",keywords:["angel","halo"]},{emoji:"ü•∞",name:"smiling_face_with_hearts",aliases:["smiling_face_with_hearts"],category:"smileys",keywords:["love","hearts","happy"]},{emoji:"üòç",name:"heart_eyes",aliases:["heart_eyes"],category:"smileys",keywords:["love","heart","adore"]},{emoji:"ü§©",name:"star_struck",aliases:["star_struck"],category:"smileys",keywords:["star","amazed"]},{emoji:"üòò",name:"kissing_heart",aliases:["kissing_heart"],category:"smileys",keywords:["kiss","love","heart"]},{emoji:"üòó",name:"kissing",aliases:["kissing"],category:"smileys",keywords:["kiss"]},{emoji:"‚ò∫Ô∏è",name:"relaxed",aliases:["relaxed"],category:"smileys",keywords:["happy","calm"]},{emoji:"üòö",name:"kissing_closed_eyes",aliases:["kissing_closed_eyes"],category:"smileys",keywords:["kiss","closed_eyes"]},{emoji:"üòô",name:"kissing_smiling_eyes",aliases:["kissing_smiling_eyes"],category:"smileys",keywords:["kiss","smile"]},{emoji:"üòã",name:"yum",aliases:["yum"],category:"smileys",keywords:["tongue","taste","delicious"]},{emoji:"üòõ",name:"stuck_out_tongue",aliases:["stuck_out_tongue"],category:"smileys",keywords:["tongue","playful"]},{emoji:"üòú",name:"stuck_out_tongue_winking_eye",aliases:["stuck_out_tongue_winking_eye"],category:"smileys",keywords:["tongue","wink","playful"]},{emoji:"ü§™",name:"zany_face",aliases:["zany_face"],category:"smileys",keywords:["crazy","silly"]},{emoji:"üòù",name:"stuck_out_tongue_closed_eyes",aliases:["stuck_out_tongue_closed_eyes"],category:"smileys",keywords:["tongue","playful"]},{emoji:"ü§ë",name:"money_mouth_face",aliases:["money_mouth_face"],category:"smileys",keywords:["money","rich"]},{emoji:"ü§ó",name:"hugs",aliases:["hugs"],category:"smileys",keywords:["hug","embrace"]},{emoji:"ü§≠",name:"hand_over_mouth",aliases:["hand_over_mouth"],category:"smileys",keywords:["quiet","secret"]},{emoji:"ü§´",name:"shushing_face",aliases:["shushing_face"],category:"smileys",keywords:["quiet","silence"]},{emoji:"ü§î",name:"thinking",aliases:["thinking"],category:"smileys",keywords:["think","consider"]},{emoji:"ü§ê",name:"zipper_mouth_face",aliases:["zipper_mouth_face"],category:"smileys",keywords:["quiet","silence"]},{emoji:"ü§®",name:"raised_eyebrow",aliases:["raised_eyebrow"],category:"smileys",keywords:["suspicious","questioning"]},{emoji:"üòê",name:"neutral_face",aliases:["neutral_face"],category:"smileys",keywords:["neutral","meh"]},{emoji:"üòë",name:"expressionless",aliases:["expressionless"],category:"smileys",keywords:["blank","neutral"]},{emoji:"üò∂",name:"no_mouth",aliases:["no_mouth"],category:"smileys",keywords:["quiet","silence"]},{emoji:"üòè",name:"smirk",aliases:["smirk"],category:"smileys",keywords:["smug","confident"]},{emoji:"üòí",name:"unamused",aliases:["unamused"],category:"smileys",keywords:["annoyed","unimpressed"]},{emoji:"üôÑ",name:"roll_eyes",aliases:["roll_eyes"],category:"smileys",keywords:["annoyed","eye_roll"]},{emoji:"üò¨",name:"grimacing",aliases:["grimacing"],category:"smileys",keywords:["awkward","uncomfortable"]},{emoji:"ü§•",name:"lying_face",aliases:["lying_face"],category:"smileys",keywords:["lie","pinocchio"]},{emoji:"üòî",name:"pensive",aliases:["pensive"],category:"smileys",keywords:["sad","thoughtful"]},{emoji:"üò™",name:"sleepy",aliases:["sleepy"],category:"smileys",keywords:["tired","sleep"]},{emoji:"ü§§",name:"drooling_face",aliases:["drooling_face"],category:"smileys",keywords:["drool","hungry"]},{emoji:"üò¥",name:"sleeping",aliases:["sleeping"],category:"smileys",keywords:["sleep","zzz"]}],negative:[{emoji:"üò∑",name:"mask",aliases:["mask"],category:"negative",keywords:["sick","ill","health"]},{emoji:"ü§í",name:"face_with_thermometer",aliases:["face_with_thermometer"],category:"negative",keywords:["sick","fever"]},{emoji:"ü§ï",name:"face_with_head_bandage",aliases:["face_with_head_bandage"],category:"negative",keywords:["hurt","injured"]},{emoji:"ü§¢",name:"nauseated_face",aliases:["nauseated_face"],category:"negative",keywords:["sick","nausea"]},{emoji:"ü§Æ",name:"vomiting_face",aliases:["vomiting_face"],category:"negative",keywords:["sick","vomit"]},{emoji:"ü§ß",name:"sneezing_face",aliases:["sneezing_face"],category:"negative",keywords:["sick","sneeze"]},{emoji:"ü•µ",name:"hot_face",aliases:["hot_face"],category:"negative",keywords:["hot","heat"]},{emoji:"ü•∂",name:"cold_face",aliases:["cold_face"],category:"negative",keywords:["cold","freeze"]},{emoji:"üòµ",name:"dizzy_face",aliases:["dizzy_face"],category:"negative",keywords:["dizzy","confused"]},{emoji:"ü§Ø",name:"exploding_head",aliases:["exploding_head"],category:"negative",keywords:["mind_blown","shocked"]},{emoji:"üòï",name:"confused",aliases:["confused"],category:"negative",keywords:["confused","unsure"]},{emoji:"üòü",name:"worried",aliases:["worried"],category:"negative",keywords:["worried","concerned"]},{emoji:"üôÅ",name:"slightly_frowning_face",aliases:["slightly_frowning_face"],category:"negative",keywords:["sad","frown"]},{emoji:"‚òπÔ∏è",name:"frowning_face",aliases:["frowning_face"],category:"negative",keywords:["sad","frown"]},{emoji:"üòÆ",name:"open_mouth",aliases:["open_mouth"],category:"negative",keywords:["surprised","shocked"]},{emoji:"üòØ",name:"hushed",aliases:["hushed"],category:"negative",keywords:["surprised","quiet"]},{emoji:"üò≤",name:"astonished",aliases:["astonished"],category:"negative",keywords:["shocked","amazed"]},{emoji:"üò≥",name:"flushed",aliases:["flushed"],category:"negative",keywords:["embarrassed","surprised"]},{emoji:"ü•∫",name:"pleading_face",aliases:["pleading_face"],category:"negative",keywords:["pleading","sad"]},{emoji:"üò¶",name:"frowning",aliases:["frowning"],category:"negative",keywords:["sad","disappointed"]},{emoji:"üòß",name:"anguished",aliases:["anguished"],category:"negative",keywords:["sad","pain"]},{emoji:"üò®",name:"fearful",aliases:["fearful"],category:"negative",keywords:["scared","fear"]},{emoji:"üò∞",name:"cold_sweat",aliases:["cold_sweat"],category:"negative",keywords:["nervous","sweat"]},{emoji:"üò•",name:"disappointed_relieved",aliases:["disappointed_relieved"],category:"negative",keywords:["sad","disappointed"]},{emoji:"üò¢",name:"cry",aliases:["cry"],category:"negative",keywords:["sad","tears"]},{emoji:"üò≠",name:"sob",aliases:["sob"],category:"negative",keywords:["sad","cry","tears"]},{emoji:"üò±",name:"scream",aliases:["scream"],category:"negative",keywords:["scared","shock"]},{emoji:"üòñ",name:"confounded",aliases:["confounded"],category:"negative",keywords:["frustrated","angry"]},{emoji:"üò£",name:"persevere",aliases:["persevere"],category:"negative",keywords:["struggling","persevere"]},{emoji:"üòû",name:"disappointed",aliases:["disappointed"],category:"negative",keywords:["sad","disappointed"]},{emoji:"üòì",name:"sweat",aliases:["sweat"],category:"negative",keywords:["tired","sweat"]},{emoji:"üò©",name:"weary",aliases:["weary"],category:"negative",keywords:["tired","exhausted"]},{emoji:"üò´",name:"tired_face",aliases:["tired_face"],category:"negative",keywords:["tired","exhausted"]},{emoji:"ü•±",name:"yawning_face",aliases:["yawning_face"],category:"negative",keywords:["tired","bored"]},{emoji:"üò§",name:"triumph",aliases:["triumph"],category:"negative",keywords:["frustrated","angry"]},{emoji:"üò°",name:"rage",aliases:["rage"],category:"negative",keywords:["angry","mad"]},{emoji:"üò†",name:"angry",aliases:["angry"],category:"negative",keywords:["angry","mad"]},{emoji:"ü§¨",name:"swearing",aliases:["swearing"],category:"negative",keywords:["angry","curse"]}],hands:[{emoji:"üëç",name:"thumbsup",aliases:["thumbsup","+1"],category:"hands",keywords:["good","approve","like"]},{emoji:"üëé",name:"thumbsdown",aliases:["thumbsdown","-1"],category:"hands",keywords:["bad","disapprove","dislike"]},{emoji:"üëå",name:"ok_hand",aliases:["ok_hand"],category:"hands",keywords:["ok","perfect"]},{emoji:"‚úåÔ∏è",name:"v",aliases:["v"],category:"hands",keywords:["peace","victory"]},{emoji:"ü§û",name:"crossed_fingers",aliases:["crossed_fingers"],category:"hands",keywords:["luck","hope"]},{emoji:"ü§ü",name:"love_you_gesture",aliases:["love_you_gesture"],category:"hands",keywords:["love","rock"]},{emoji:"ü§ò",name:"metal",aliases:["metal"],category:"hands",keywords:["rock","metal"]},{emoji:"ü§ô",name:"call_me_hand",aliases:["call_me_hand"],category:"hands",keywords:["call","phone"]},{emoji:"üëà",name:"point_left",aliases:["point_left"],category:"hands",keywords:["point","left"]},{emoji:"üëâ",name:"point_right",aliases:["point_right"],category:"hands",keywords:["point","right"]},{emoji:"üëÜ",name:"point_up_2",aliases:["point_up_2"],category:"hands",keywords:["point","up"]},{emoji:"üñï",name:"middle_finger",aliases:["middle_finger"],category:"hands",keywords:["rude","offensive"]},{emoji:"üëá",name:"point_down",aliases:["point_down"],category:"hands",keywords:["point","down"]},{emoji:"‚òùÔ∏è",name:"point_up",aliases:["point_up"],category:"hands",keywords:["point","up"]},{emoji:"üëè",name:"clap",aliases:["clap"],category:"hands",keywords:["applause","clap"]},{emoji:"üôå",name:"raised_hands",aliases:["raised_hands"],category:"hands",keywords:["celebrate","praise"]},{emoji:"üëê",name:"open_hands",aliases:["open_hands"],category:"hands",keywords:["open","hug"]},{emoji:"ü§≤",name:"palms_up_together",aliases:["palms_up_together"],category:"hands",keywords:["pray","please"]},{emoji:"ü§ù",name:"handshake",aliases:["handshake"],category:"hands",keywords:["deal","agree"]},{emoji:"üôè",name:"pray",aliases:["pray"],category:"hands",keywords:["pray","thanks"]},{emoji:"‚úçÔ∏è",name:"writing_hand",aliases:["writing_hand"],category:"hands",keywords:["write","sign"]},{emoji:"üíÖ",name:"nail_care",aliases:["nail_care"],category:"hands",keywords:["nails","beauty"]},{emoji:"ü§≥",name:"selfie",aliases:["selfie"],category:"hands",keywords:["selfie","photo"]},{emoji:"üí™",name:"muscle",aliases:["muscle"],category:"hands",keywords:["strong","flex"]}],hearts:[{emoji:"‚ù§Ô∏è",name:"heart",aliases:["heart"],category:"hearts",keywords:["love","heart"]},{emoji:"üß°",name:"orange_heart",aliases:["orange_heart"],category:"hearts",keywords:["love","orange"]},{emoji:"üíõ",name:"yellow_heart",aliases:["yellow_heart"],category:"hearts",keywords:["love","yellow"]},{emoji:"üíö",name:"green_heart",aliases:["green_heart"],category:"hearts",keywords:["love","green"]},{emoji:"üíô",name:"blue_heart",aliases:["blue_heart"],category:"hearts",keywords:["love","blue"]},{emoji:"üíú",name:"purple_heart",aliases:["purple_heart"],category:"hearts",keywords:["love","purple"]},{emoji:"üñ§",name:"black_heart",aliases:["black_heart"],category:"hearts",keywords:["love","black"]},{emoji:"ü§ç",name:"white_heart",aliases:["white_heart"],category:"hearts",keywords:["love","white"]},{emoji:"ü§é",name:"brown_heart",aliases:["brown_heart"],category:"hearts",keywords:["love","brown"]},{emoji:"üíî",name:"broken_heart",aliases:["broken_heart"],category:"hearts",keywords:["sad","heartbreak"]},{emoji:"‚ù£Ô∏è",name:"heavy_heart_exclamation",aliases:["heavy_heart_exclamation"],category:"hearts",keywords:["love","exclamation"]},{emoji:"üíï",name:"two_hearts",aliases:["two_hearts"],category:"hearts",keywords:["love","hearts"]},{emoji:"üíû",name:"revolving_hearts",aliases:["revolving_hearts"],category:"hearts",keywords:["love","revolving"]},{emoji:"üíì",name:"heartbeat",aliases:["heartbeat"],category:"hearts",keywords:["love","beat"]},{emoji:"üíó",name:"heartpulse",aliases:["heartpulse"],category:"hearts",keywords:["love","pulse"]},{emoji:"üíñ",name:"sparkling_heart",aliases:["sparkling_heart"],category:"hearts",keywords:["love","sparkle"]},{emoji:"üíò",name:"cupid",aliases:["cupid"],category:"hearts",keywords:["love","cupid"]},{emoji:"üíù",name:"gift_heart",aliases:["gift_heart"],category:"hearts",keywords:["love","gift"]},{emoji:"üíü",name:"heart_decoration",aliases:["heart_decoration"],category:"hearts",keywords:["love","decoration"]}],objects:[{emoji:"üî•",name:"fire",aliases:["fire"],category:"objects",keywords:["hot","flame"]},{emoji:"‚≠ê",name:"star",aliases:["star"],category:"objects",keywords:["star","favorite"]},{emoji:"üåü",name:"star2",aliases:["star2"],category:"objects",keywords:["star","sparkle"]},{emoji:"‚ú®",name:"sparkles",aliases:["sparkles"],category:"objects",keywords:["sparkle","magic"]},{emoji:"‚ö°",name:"zap",aliases:["zap"],category:"objects",keywords:["lightning","electric"]},{emoji:"üíé",name:"gem",aliases:["gem"],category:"objects",keywords:["diamond","precious"]},{emoji:"üíØ",name:"100",aliases:["100"],category:"objects",keywords:["perfect","hundred"]},{emoji:"üéâ",name:"tada",aliases:["tada"],category:"objects",keywords:["celebrate","party"]},{emoji:"üéä",name:"confetti_ball",aliases:["confetti_ball"],category:"objects",keywords:["celebrate","party"]},{emoji:"üéà",name:"balloon",aliases:["balloon"],category:"objects",keywords:["party","celebrate"]},{emoji:"üéÅ",name:"gift",aliases:["gift"],category:"objects",keywords:["present","gift"]},{emoji:"üèÜ",name:"trophy",aliases:["trophy"],category:"objects",keywords:["win","award"]},{emoji:"ü•á",name:"first_place_medal",aliases:["first_place_medal"],category:"objects",keywords:["gold","first"]},{emoji:"ü•à",name:"second_place_medal",aliases:["second_place_medal"],category:"objects",keywords:["silver","second"]},{emoji:"ü•â",name:"third_place_medal",aliases:["third_place_medal"],category:"objects",keywords:["bronze","third"]},{emoji:"üéØ",name:"dart",aliases:["dart"],category:"objects",keywords:["target","bullseye"]},{emoji:"üé™",name:"circus_tent",aliases:["circus_tent"],category:"objects",keywords:["circus","fun"]}]},Ua=Object.values(ni).flat();function ii(s,t=10){if(!s)return[];const a=s.toLowerCase(),c=[];for(const o of Ua){if(o.name===a||o.aliases.includes(a)){c.unshift(o);continue}if(o.name.startsWith(a)||o.aliases.some(d=>d.startsWith(a))){c.push(o);continue}if(o.keywords.some(d=>d.includes(a))){c.push(o);continue}(o.name.includes(a)||o.aliases.some(d=>d.includes(a)))&&c.push(o)}return c.filter((o,d,i)=>i.findIndex(m=>m.emoji===o.emoji)===d).slice(0,t)}function Fa(s){const t=/:([a-zA-Z0-9_+-]+):/g;let a=!1;return{content:s.replace(t,(l,o)=>{const d=Ua.find(i=>i.name===o||i.aliases.includes(o));return d?(a=!0,d.emoji):l}),hasEmojis:a}}const oi=s=>{const t=[];let a=s;const c=/@(?:"([^"]+)"|(\S+))/g;let l;for(;(l=c.exec(s))!==null;){const o=l[0],d=l[1]||l[2],i=l.index,m=l.index+o.length;t.push({user_id:d,username:d,display_name:d,start_index:i,end_index:m})}return{content:a,mentions:t}},Mt=s=>s.includes(" ")?`@"${s}"`:`@${s}`,li=(s,t)=>{if(!Array.isArray(t)||t.length===0)return{segments:[{type:"text",content:s}]};const a=[];let c=0;const l=[...t].sort((o,d)=>(o.start_index||0)-(d.start_index||0));for(const o of l){const d=o.start_index||0,i=o.end_index||d;if(d>c){const r=s.slice(c,d);r&&a.push({type:"text",content:r})}const m=s.slice(d,i);m&&a.push({type:"mention",content:m,mention:{user_id:o.user_id||"",username:o.username||"",display_name:o.display_name||o.username||"",start_index:d,end_index:i}}),c=i}if(c<s.length){const o=s.slice(c);o&&a.push({type:"text",content:o})}return{segments:a}},Oa=({content:s,mentions:t=[],className:a=""})=>{const{user:c}=J();let l=s;try{if(s.startsWith("{")&&s.endsWith("}")){const r=JSON.parse(s);r.content?l=r.content:r.message?l=r.message:r.text&&(l=r.text)}}catch{l=s}const{content:o}=Fa(l),{segments:d}=li(o,t),i=(r,u)=>{var h,x,v,j,y;if(r.type==="mention"){const k=c&&(((h=r.mention)==null?void 0:h.user_id)===c.id||((x=r.mention)==null?void 0:x.username)===((v=c.user_metadata)==null?void 0:v.name)||((j=r.mention)==null?void 0:j.username)===c.email);return e.jsx("span",{className:`
            inline-block px-1.5 py-0.5 mx-0.5 rounded text-sm font-medium
            ${k?"bg-primary/20 text-primary border border-primary/30":"bg-accent text-accent-foreground border border-border"}
            hover:bg-opacity-80 transition-colors cursor-pointer
          `,title:`Mentioned user: ${((y=r.mention)==null?void 0:y.display_name)||r.content}`,onClick:()=>{console.log("Clicked mention:",r.mention)},children:r.content},`mention-${u}`)}const f=ri(r.content);return e.jsx("span",{children:f.map((k,p)=>m(k,`${u}-${p}`))},`text-${u}`)},m=(r,u)=>{switch(r.type){case"bold":return e.jsx("strong",{className:"font-bold",children:r.content},u);case"italic":return e.jsx("em",{className:"italic",children:r.content},u);case"underline":return e.jsx("u",{className:"underline",children:r.content},u);case"strikethrough":return e.jsx("s",{className:"line-through opacity-75",children:r.content},u);case"inline-code":return e.jsx("code",{className:"px-1.5 py-0.5 mx-0.5 bg-muted text-muted-foreground rounded text-sm font-mono",children:r.content},u);case"code-block":return e.jsxs("div",{className:"my-2 p-3 bg-muted rounded-lg border",children:[r.language&&e.jsx("div",{className:"text-xs text-muted-foreground mb-2 font-mono opacity-75",children:r.language}),e.jsx("pre",{className:"text-sm font-mono whitespace-pre-wrap overflow-x-auto",children:e.jsx("code",{children:r.content})})]},u);case"blockquote":return e.jsx("div",{className:"my-2 pl-3 border-l-4 border-primary/30 bg-primary/5 py-2 pr-3 rounded-r",children:e.jsx("div",{className:"text-sm italic text-muted-foreground",children:r.content})},u);case"link":return e.jsx("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:text-primary/80 underline underline-offset-2 transition-colors",children:r.content},u);case"list-item":return e.jsxs("div",{className:"flex items-start gap-2 my-1",children:[e.jsx("span",{className:"text-primary mt-1.5 text-xs",children:"‚Ä¢"}),e.jsx("span",{className:"flex-1",children:r.content})]},u);default:return e.jsx("span",{dangerouslySetInnerHTML:{__html:yn(r.content)}},u)}};return e.jsx("div",{className:`text-sm leading-relaxed break-words ${a}`,children:d.map((r,u)=>i(r,u))})},ci=({message:s,isOwn:t,guestName:a,reactions:c={},onReact:l,onReport:o,onEdit:d,onDelete:i,onReply:m,onPrivateMessage:r})=>{const{user:u}=J(),[f,h]=n.useState(!1),x=b=>{const N=new Date(b),C=new Date;return N.toDateString()===C.toDateString()?N.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):N.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},v=()=>s.is_bot_message?"@bot":s.sender_id&&(u==null?void 0:u.id)===s.sender_id?"You":s.sender_name,j=()=>s.is_bot_message?e.jsx(ut,{className:"w-4 h-4"}):v().charAt(0).toUpperCase(),y=b=>{l==null||l(s.id,b)},k=(b,N)=>{o==null||o(s.id,b,N)},p=u&&s.mentions&&s.mentions.some(b=>{var N;return b.user_id===u.id||b.username===((N=u.user_metadata)==null?void 0:N.name)||b.username===u.email}),g=Object.values(c).some(b=>b.count>0);return e.jsxs("div",{"data-message-id":s.id,className:`group flex gap-2 md:gap-3 mb-3 md:mb-4 animate-fade-in transition-all duration-200 ${t?"flex-row-reverse":"flex-row"}`,onMouseEnter:()=>h(!0),onMouseLeave:()=>h(!1),onTouchStart:()=>h(!0),onTouchEnd:()=>setTimeout(()=>h(!1),2e3),children:[e.jsx("div",{className:`w-7 h-7 md:w-8 md:h-8 rounded-full flex items-center justify-center text-xs font-semibold flex-shrink-0 transition-transform duration-200 group-hover:scale-105 ${s.is_bot_message?"bg-primary/30 text-primary border-2 border-primary/50":"bg-primary/20"}`,children:j()}),e.jsxs("div",{className:`max-w-[80%] md:max-w-[70%] ${t?"items-end":"items-start"} flex flex-col relative`,children:[e.jsxs("div",{className:`
          px-3 py-2 md:px-4 md:py-2 rounded-lg relative group/bubble
          ${s.is_bot_message?"bg-gradient-to-r from-primary/10 to-primary/5 border border-primary/20 chat-bubble-bot":t?"chat-bubble-own rounded-br-sm":"chat-bubble-other rounded-bl-sm"}
          ${p?"ring-1 ring-primary/30 bg-primary/5":""}
          neon-border transition-all duration-200 hover:shadow-lg
        `,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 text-xs opacity-75",children:[e.jsx("span",{className:`font-medium ${s.is_bot_message?"text-primary":""}`,children:v()}),s.is_bot_message&&e.jsx("span",{className:"text-primary bg-primary/10 px-1.5 py-0.5 rounded text-xs font-medium",children:"AI"}),e.jsx("span",{children:x(s.created_at)})]}),s.is_deleted?e.jsx("div",{className:"text-sm italic text-muted-foreground",children:"This message was deleted"}):e.jsx(Oa,{content:s.content,mentions:s.mentions||[]}),s.edited_at&&e.jsx("span",{className:"text-xs text-muted-foreground ml-2 italic",children:"(edited)"}),e.jsxs("div",{className:`
            absolute ${t?"left-0 top-1 md:top-2 -translate-x-full -ml-1 md:-ml-2":"right-0 top-1 md:top-2 translate-x-full mr-1 md:mr-2"}
            flex items-center gap-1 transition-all duration-200
            ${f?"opacity-100 scale-100":"opacity-0 scale-95 pointer-events-none"}
          `,children:[e.jsx(Et,{messageId:s.id,reactions:c,onReact:y,compact:!0}),e.jsx(ai,{messageId:s.id,isOwn:t,content:s.content,senderName:s.sender_name,senderId:s.sender_id,onReport:t?void 0:k,onEdit:t&&d?b=>d(s.id,b):void 0,onDelete:t&&i?()=>i(s.id):void 0,onReply:m?()=>m(s.id):void 0,onPrivateMessage:!t&&r?r:void 0})]})]}),g&&e.jsx("div",{className:"mt-1 flex items-center gap-1",children:e.jsx(Et,{messageId:s.id,reactions:c,onReact:y})}),e.jsxs("div",{className:`
          flex items-center gap-1 mt-1 transition-opacity duration-200
          ${f?"md:opacity-0":"opacity-100"}
          md:hidden
        `,children:[e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>y("‚ù§Ô∏è"),className:"h-7 px-2 text-xs text-muted-foreground hover:text-red-500 transition-colors",children:[e.jsx(Ht,{className:"w-3 h-3 mr-1"}),"Like"]}),!t&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>k("inappropriate"),className:"h-7 px-2 text-xs text-muted-foreground hover:text-orange-500 transition-colors",children:[e.jsx(Vt,{className:"w-3 h-3 mr-1"}),"Report"]})]})]})]})},di=({suggestions:s,selectedIndex:t,onSelect:a,onHover:c,position:l={top:0,left:0},visible:o})=>{const d=n.useRef(null);return n.useEffect(()=>{if(o&&d.current&&t>=0){const i=d.current.children[t];i&&i.scrollIntoView({block:"nearest",behavior:"smooth"})}},[t,o]),!o||s.length===0?null:e.jsx("div",{ref:d,className:"absolute z-50 bg-background border border-border rounded-lg shadow-lg max-h-48 overflow-y-auto min-w-[200px]",style:{top:l.top,left:l.left,transform:"translateY(-100%)"},children:s.map((i,m)=>e.jsxs("div",{className:`
            flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors
            ${m===t?"bg-accent text-accent-foreground":"hover:bg-accent/50"}
            ${m===0?"rounded-t-lg":""}
            ${m===s.length-1?"rounded-b-lg":""}
          `,onClick:()=>a(i),onMouseEnter:()=>c(m),role:"button",tabIndex:-1,children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[i.isMember?e.jsx(Es,{className:"w-3 h-3 text-warning flex-shrink-0"}):e.jsx(He,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:i.displayName})]}),e.jsx("div",{className:"flex items-center gap-1",children:i.isMember?e.jsx(le,{variant:"secondary",className:"text-xs px-1.5 py-0.5 bg-warning/10 text-warning border-warning/20",children:"Premium"}):e.jsx(le,{variant:"secondary",className:"text-xs px-1.5 py-0.5 bg-muted/50",children:"Guest"})})]},i.id))})},mi=({visible:s,query:t,position:a,onSelect:c,onClose:l,selectedIndex:o,onHover:d})=>{const[i,m]=n.useState([]),r=n.useRef(null);return n.useEffect(()=>{if(t){const u=ii(t,8);m(u)}else m([])},[t]),n.useEffect(()=>{const u=f=>{r.current&&!r.current.contains(f.target)&&l()};return s&&document.addEventListener("mousedown",u),()=>{document.removeEventListener("mousedown",u)}},[s,l]),!s||i.length===0?null:e.jsxs("div",{ref:r,className:"fixed z-50 bg-popover border border-border rounded-lg shadow-lg p-2 max-w-xs",style:{top:a.top-10,left:a.left,transform:"translateY(-100%)"},children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-2 px-2",children:"Emoji suggestions"}),e.jsx("div",{className:"space-y-1",children:i.map((u,f)=>e.jsxs(_,{variant:f===o?"secondary":"ghost",size:"sm",className:"w-full justify-start text-left h-8 px-2",onClick:()=>c(u),onMouseEnter:()=>d(f),children:[e.jsx("span",{className:"text-lg mr-2",children:u.emoji}),e.jsxs("span",{className:"flex-1 truncate",children:[":",u.name,":"]}),u.aliases.length>1&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["+",u.aliases.length-1]})]},`${u.emoji}-${f}`))}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2 px-2 text-center",children:"‚Üë‚Üì to navigate ‚Ä¢ Enter to select ‚Ä¢ Esc to close"})]})};var At=1,ui=.9,hi=.8,fi=.17,Ps=.1,zs=.999,pi=.9999,xi=.99,gi=/[\\\/_+.#"@\[\(\{&]/,yi=/[\\\/_+.#"@\[\(\{&]/g,vi=/[\s-]/,qa=/[\s-]/g;function Xs(s,t,a,c,l,o,d){if(o===t.length)return l===s.length?At:xi;var i=`${l},${o}`;if(d[i]!==void 0)return d[i];for(var m=c.charAt(o),r=a.indexOf(m,l),u=0,f,h,x,v;r>=0;)f=Xs(s,t,a,c,r+1,o+1,d),f>u&&(r===l?f*=At:gi.test(s.charAt(r-1))?(f*=hi,x=s.slice(l,r-1).match(yi),x&&l>0&&(f*=Math.pow(zs,x.length))):vi.test(s.charAt(r-1))?(f*=ui,v=s.slice(l,r-1).match(qa),v&&l>0&&(f*=Math.pow(zs,v.length))):(f*=fi,l>0&&(f*=Math.pow(zs,r-l))),s.charAt(r)!==t.charAt(o)&&(f*=pi)),(f<Ps&&a.charAt(r-1)===c.charAt(o+1)||c.charAt(o+1)===c.charAt(o)&&a.charAt(r-1)!==c.charAt(o))&&(h=Xs(s,t,a,c,r+1,o+2,d),h*Ps>f&&(f=h*Ps)),f>u&&(u=f),r=a.indexOf(m,r+1);return d[i]=u,u}function Dt(s){return s.toLowerCase().replace(qa," ")}function ji(s,t,a){return s=a&&a.length>0?`${s+" "+a.join(" ")}`:s,Xs(s,t,Dt(s),Dt(t),0,0,{})}var wi=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],Re=wi.reduce((s,t)=>{const a=wr(`Primitive.${t}`),c=n.forwardRef((l,o)=>{const{asChild:d,...i}=l,m=d?a:t;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(m,{...i,ref:o})});return c.displayName=`Primitive.${t}`,{...s,[t]:c}},{}),Je='[cmdk-group=""]',$s='[cmdk-group-items=""]',bi='[cmdk-group-heading=""]',Va='[cmdk-item=""]',It=`${Va}:not([aria-disabled="true"])`,Js="cmdk-item-select",qe="data-value",Ni=(s,t,a)=>ji(s,t,a),Ga=n.createContext(void 0),is=()=>n.useContext(Ga),Ha=n.createContext(void 0),xt=()=>n.useContext(Ha),Wa=n.createContext(void 0),Ya=n.forwardRef((s,t)=>{let a=Ve(()=>{var w,L;return{search:"",value:(L=(w=s.value)!=null?w:s.defaultValue)!=null?L:"",selectedItemId:void 0,filtered:{count:0,items:new Map,groups:new Set}}}),c=Ve(()=>new Set),l=Ve(()=>new Map),o=Ve(()=>new Map),d=Ve(()=>new Set),i=Ka(s),{label:m,children:r,value:u,onValueChange:f,filter:h,shouldFilter:x,loop:v,disablePointerSelection:j=!1,vimBindings:y=!0,...k}=s,p=Ge(),g=Ge(),b=Ge(),N=n.useRef(null),C=Ti();Pe(()=>{if(u!==void 0){let w=u.trim();a.current.value=w,I.emit()}},[u]),Pe(()=>{C(6,he)},[]);let I=n.useMemo(()=>({subscribe:w=>(d.current.add(w),()=>d.current.delete(w)),snapshot:()=>a.current,setState:(w,L,$)=>{var M,F,W,ae;if(!Object.is(a.current[w],L)){if(a.current[w]=L,w==="search")me(),Y(),C(1,ie);else if(w==="value"){if(document.activeElement.hasAttribute("cmdk-input")||document.activeElement.hasAttribute("cmdk-root")){let Z=document.getElementById(b);Z?Z.focus():(M=document.getElementById(p))==null||M.focus()}if(C(7,()=>{var Z;a.current.selectedItemId=(Z=oe())==null?void 0:Z.id,I.emit()}),$||C(5,he),((F=i.current)==null?void 0:F.value)!==void 0){let Z=L??"";(ae=(W=i.current).onValueChange)==null||ae.call(W,Z);return}}I.emit()}},emit:()=>{d.current.forEach(w=>w())}}),[]),U=n.useMemo(()=>({value:(w,L,$)=>{var M;L!==((M=o.current.get(w))==null?void 0:M.value)&&(o.current.set(w,{value:L,keywords:$}),a.current.filtered.items.set(w,q(L,$)),C(2,()=>{Y(),I.emit()}))},item:(w,L)=>(c.current.add(w),L&&(l.current.has(L)?l.current.get(L).add(w):l.current.set(L,new Set([w]))),C(3,()=>{me(),Y(),a.current.value||ie(),I.emit()}),()=>{o.current.delete(w),c.current.delete(w),a.current.filtered.items.delete(w);let $=oe();C(4,()=>{me(),($==null?void 0:$.getAttribute("id"))===w&&ie(),I.emit()})}),group:w=>(l.current.has(w)||l.current.set(w,new Set),()=>{o.current.delete(w),l.current.delete(w)}),filter:()=>i.current.shouldFilter,label:m||s["aria-label"],getDisablePointerSelection:()=>i.current.disablePointerSelection,listId:p,inputId:b,labelId:g,listInnerRef:N}),[]);function q(w,L){var $,M;let F=(M=($=i.current)==null?void 0:$.filter)!=null?M:Ni;return w?F(w,a.current.search,L):0}function Y(){if(!a.current.search||i.current.shouldFilter===!1)return;let w=a.current.filtered.items,L=[];a.current.filtered.groups.forEach(M=>{let F=l.current.get(M),W=0;F.forEach(ae=>{let Z=w.get(ae);W=Math.max(Z,W)}),L.push([M,W])});let $=N.current;H().sort((M,F)=>{var W,ae;let Z=M.getAttribute("id"),ge=F.getAttribute("id");return((W=w.get(ge))!=null?W:0)-((ae=w.get(Z))!=null?ae:0)}).forEach(M=>{let F=M.closest($s);F?F.appendChild(M.parentElement===F?M:M.closest(`${$s} > *`)):$.appendChild(M.parentElement===$?M:M.closest(`${$s} > *`))}),L.sort((M,F)=>F[1]-M[1]).forEach(M=>{var F;let W=(F=N.current)==null?void 0:F.querySelector(`${Je}[${qe}="${encodeURIComponent(M[0])}"]`);W==null||W.parentElement.appendChild(W)})}function ie(){let w=H().find($=>$.getAttribute("aria-disabled")!=="true"),L=w==null?void 0:w.getAttribute(qe);I.setState("value",L||void 0)}function me(){var w,L,$,M;if(!a.current.search||i.current.shouldFilter===!1){a.current.filtered.count=c.current.size;return}a.current.filtered.groups=new Set;let F=0;for(let W of c.current){let ae=(L=(w=o.current.get(W))==null?void 0:w.value)!=null?L:"",Z=(M=($=o.current.get(W))==null?void 0:$.keywords)!=null?M:[],ge=q(ae,Z);a.current.filtered.items.set(W,ge),ge>0&&F++}for(let[W,ae]of l.current)for(let Z of ae)if(a.current.filtered.items.get(Z)>0){a.current.filtered.groups.add(W);break}a.current.filtered.count=F}function he(){var w,L,$;let M=oe();M&&(((w=M.parentElement)==null?void 0:w.firstChild)===M&&(($=(L=M.closest(Je))==null?void 0:L.querySelector(bi))==null||$.scrollIntoView({block:"nearest"})),M.scrollIntoView({block:"nearest"}))}function oe(){var w;return(w=N.current)==null?void 0:w.querySelector(`${Va}[aria-selected="true"]`)}function H(){var w;return Array.from(((w=N.current)==null?void 0:w.querySelectorAll(It))||[])}function se(w){let L=H()[w];L&&I.setState("value",L.getAttribute(qe))}function xe(w){var L;let $=oe(),M=H(),F=M.findIndex(ae=>ae===$),W=M[F+w];(L=i.current)!=null&&L.loop&&(W=F+w<0?M[M.length-1]:F+w===M.length?M[0]:M[F+w]),W&&I.setState("value",W.getAttribute(qe))}function ue(w){let L=oe(),$=L==null?void 0:L.closest(Je),M;for(;$&&!M;)$=w>0?Di($,Je):Ii($,Je),M=$==null?void 0:$.querySelector(It);M?I.setState("value",M.getAttribute(qe)):xe(w)}let Ue=()=>se(H().length-1),fe=w=>{w.preventDefault(),w.metaKey?Ue():w.altKey?ue(1):xe(1)},_e=w=>{w.preventDefault(),w.metaKey?se(0):w.altKey?ue(-1):xe(-1)};return n.createElement(Re.div,{ref:t,tabIndex:-1,...k,"cmdk-root":"",onKeyDown:w=>{var L;(L=k.onKeyDown)==null||L.call(k,w);let $=w.nativeEvent.isComposing||w.keyCode===229;if(!(w.defaultPrevented||$))switch(w.key){case"n":case"j":{y&&w.ctrlKey&&fe(w);break}case"ArrowDown":{fe(w);break}case"p":case"k":{y&&w.ctrlKey&&_e(w);break}case"ArrowUp":{_e(w);break}case"Home":{w.preventDefault(),se(0);break}case"End":{w.preventDefault(),Ue();break}case"Enter":{w.preventDefault();let M=oe();if(M){let F=new Event(Js);M.dispatchEvent(F)}}}}},n.createElement("label",{"cmdk-label":"",htmlFor:U.inputId,id:U.labelId,style:Pi},m),Is(s,w=>n.createElement(Ha.Provider,{value:I},n.createElement(Ga.Provider,{value:U},w))))}),ki=n.forwardRef((s,t)=>{var a,c;let l=Ge(),o=n.useRef(null),d=n.useContext(Wa),i=is(),m=Ka(s),r=(c=(a=m.current)==null?void 0:a.forceMount)!=null?c:d==null?void 0:d.forceMount;Pe(()=>{if(!r)return i.item(l,d==null?void 0:d.id)},[r]);let u=Qa(l,o,[s.value,s.children,o],s.keywords),f=xt(),h=Ee(C=>C.value&&C.value===u.current),x=Ee(C=>r||i.filter()===!1?!0:C.search?C.filtered.items.get(l)>0:!0);n.useEffect(()=>{let C=o.current;if(!(!C||s.disabled))return C.addEventListener(Js,v),()=>C.removeEventListener(Js,v)},[x,s.onSelect,s.disabled]);function v(){var C,I;j(),(I=(C=m.current).onSelect)==null||I.call(C,u.current)}function j(){f.setState("value",u.current,!0)}if(!x)return null;let{disabled:y,value:k,onSelect:p,forceMount:g,keywords:b,...N}=s;return n.createElement(Re.div,{ref:es(o,t),...N,id:l,"cmdk-item":"",role:"option","aria-disabled":!!y,"aria-selected":!!h,"data-disabled":!!y,"data-selected":!!h,onPointerMove:y||i.getDisablePointerSelection()?void 0:j,onClick:y?void 0:v},s.children)}),_i=n.forwardRef((s,t)=>{let{heading:a,children:c,forceMount:l,...o}=s,d=Ge(),i=n.useRef(null),m=n.useRef(null),r=Ge(),u=is(),f=Ee(x=>l||u.filter()===!1?!0:x.search?x.filtered.groups.has(d):!0);Pe(()=>u.group(d),[]),Qa(d,i,[s.value,s.heading,m]);let h=n.useMemo(()=>({id:d,forceMount:l}),[l]);return n.createElement(Re.div,{ref:es(i,t),...o,"cmdk-group":"",role:"presentation",hidden:f?void 0:!0},a&&n.createElement("div",{ref:m,"cmdk-group-heading":"","aria-hidden":!0,id:r},a),Is(s,x=>n.createElement("div",{"cmdk-group-items":"",role:"group","aria-labelledby":a?r:void 0},n.createElement(Wa.Provider,{value:h},x))))}),Si=n.forwardRef((s,t)=>{let{alwaysRender:a,...c}=s,l=n.useRef(null),o=Ee(d=>!d.search);return!a&&!o?null:n.createElement(Re.div,{ref:es(l,t),...c,"cmdk-separator":"",role:"separator"})}),Ci=n.forwardRef((s,t)=>{let{onValueChange:a,...c}=s,l=s.value!=null,o=xt(),d=Ee(r=>r.search),i=Ee(r=>r.selectedItemId),m=is();return n.useEffect(()=>{s.value!=null&&o.setState("search",s.value)},[s.value]),n.createElement(Re.input,{ref:t,...c,"cmdk-input":"",autoComplete:"off",autoCorrect:"off",spellCheck:!1,"aria-autocomplete":"list",role:"combobox","aria-expanded":!0,"aria-controls":m.listId,"aria-labelledby":m.labelId,"aria-activedescendant":i,id:m.inputId,type:"text",value:l?s.value:d,onChange:r=>{l||o.setState("search",r.target.value),a==null||a(r.target.value)}})}),Ei=n.forwardRef((s,t)=>{let{children:a,label:c="Suggestions",...l}=s,o=n.useRef(null),d=n.useRef(null),i=Ee(r=>r.selectedItemId),m=is();return n.useEffect(()=>{if(d.current&&o.current){let r=d.current,u=o.current,f,h=new ResizeObserver(()=>{f=requestAnimationFrame(()=>{let x=r.offsetHeight;u.style.setProperty("--cmdk-list-height",x.toFixed(1)+"px")})});return h.observe(r),()=>{cancelAnimationFrame(f),h.unobserve(r)}}},[]),n.createElement(Re.div,{ref:es(o,t),...l,"cmdk-list":"",role:"listbox",tabIndex:-1,"aria-activedescendant":i,"aria-label":c,id:m.listId},Is(s,r=>n.createElement("div",{ref:es(d,m.listInnerRef),"cmdk-list-sizer":""},r)))}),Ri=n.forwardRef((s,t)=>{let{open:a,onOpenChange:c,overlayClassName:l,contentClassName:o,container:d,...i}=s;return n.createElement(zt,{open:a,onOpenChange:c},n.createElement($t,{container:d},n.createElement(Ft,{"cmdk-overlay":"",className:l}),n.createElement(Bt,{"aria-label":s.label,"cmdk-dialog":"",className:o},n.createElement(Ya,{ref:t,...i}))))}),Mi=n.forwardRef((s,t)=>Ee(a=>a.filtered.count===0)?n.createElement(Re.div,{ref:t,...s,"cmdk-empty":"",role:"presentation"}):null),Ai=n.forwardRef((s,t)=>{let{progress:a,children:c,label:l="Loading...",...o}=s;return n.createElement(Re.div,{ref:t,...o,"cmdk-loading":"",role:"progressbar","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":100,"aria-label":l},Is(s,d=>n.createElement("div",{"aria-hidden":!0},d)))}),de=Object.assign(Ya,{List:Ei,Item:ki,Input:Ci,Group:_i,Separator:Si,Dialog:Ri,Empty:Mi,Loading:Ai});function Di(s,t){let a=s.nextElementSibling;for(;a;){if(a.matches(t))return a;a=a.nextElementSibling}}function Ii(s,t){let a=s.previousElementSibling;for(;a;){if(a.matches(t))return a;a=a.previousElementSibling}}function Ka(s){let t=n.useRef(s);return Pe(()=>{t.current=s}),t}var Pe=typeof window>"u"?n.useEffect:n.useLayoutEffect;function Ve(s){let t=n.useRef();return t.current===void 0&&(t.current=s()),t}function Ee(s){let t=xt(),a=()=>s(t.snapshot());return n.useSyncExternalStore(t.subscribe,a,a)}function Qa(s,t,a,c=[]){let l=n.useRef(),o=is();return Pe(()=>{var d;let i=(()=>{var r;for(let u of a){if(typeof u=="string")return u.trim();if(typeof u=="object"&&"current"in u)return u.current?(r=u.current.textContent)==null?void 0:r.trim():l.current}})(),m=c.map(r=>r.trim());o.value(s,i,m),(d=t.current)==null||d.setAttribute(qe,i),l.current=i}),l}var Ti=()=>{let[s,t]=n.useState(),a=Ve(()=>new Map);return Pe(()=>{a.current.forEach(c=>c()),a.current=new Map},[s]),(c,l)=>{a.current.set(c,l),t({})}};function Li(s){let t=s.type;return typeof t=="function"?t(s.props):"render"in t?t.render(s.props):s}function Is({asChild:s,children:t},a){return s&&n.isValidElement(t)?n.cloneElement(Li(t),{ref:t.ref},a(t.props.children)):a(t)}var Pi={position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"};const Xa=n.forwardRef(({className:s,...t},a)=>e.jsx(de,{ref:a,className:ne("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...t}));Xa.displayName=de.displayName;const zi=n.forwardRef(({className:s,...t},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(rs,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(de.Input,{ref:a,className:ne("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...t})]}));zi.displayName=de.Input.displayName;const Ja=n.forwardRef(({className:s,...t},a)=>e.jsx(de.List,{ref:a,className:ne("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...t}));Ja.displayName=de.List.displayName;const Za=n.forwardRef((s,t)=>e.jsx(de.Empty,{ref:t,className:"py-6 text-center text-sm",...s}));Za.displayName=de.Empty.displayName;const er=n.forwardRef(({className:s,...t},a)=>e.jsx(de.Group,{ref:a,className:ne("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...t}));er.displayName=de.Group.displayName;const $i=n.forwardRef(({className:s,...t},a)=>e.jsx(de.Separator,{ref:a,className:ne("-mx-1 h-px bg-border",s),...t}));$i.displayName=de.Separator.displayName;const sr=n.forwardRef(({className:s,...t},a)=>e.jsx(de.Item,{ref:a,className:ne("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",s),...t}));sr.displayName=de.Item.displayName;const Bi=({suggestions:s,onSelect:t,isVisible:a})=>!a||s.length===0?null:e.jsx("div",{className:"absolute bottom-full left-0 right-0 mb-2 z-50",children:e.jsx("div",{className:"bg-background border border-border rounded-lg shadow-lg max-h-48 overflow-hidden",children:e.jsx(Xa,{children:e.jsxs(Ja,{children:[e.jsx(Za,{children:"No commands found."}),e.jsx(er,{children:s.map((c,l)=>e.jsxs(sr,{onSelect:()=>t(c.name),className:"flex flex-col items-start gap-1 p-3 cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx("span",{className:"font-mono text-primary font-medium",children:c.name}),e.jsx("span",{className:"text-xs text-muted-foreground flex-1",children:c.description})]}),e.jsx("div",{className:"text-xs text-muted-foreground font-mono opacity-75",children:c.usage})]},c.name))})]})})})}),Ui=({onAudioRecorded:s,disabled:t})=>{const[a,c]=n.useState(!1),[l,o]=n.useState(0),[d,i]=n.useState(null),[m,r]=n.useState(!1),u=n.useRef(null),f=n.useRef([]),h=n.useRef(null),x=n.useRef(null),{toast:v}=ee();n.useEffect(()=>()=>{h.current&&clearInterval(h.current),x.current&&(x.current.pause(),x.current=null)},[]);const j=async()=>{try{const C=await navigator.mediaDevices.getUserMedia({audio:!0});u.current=new MediaRecorder(C),f.current=[],u.current.ondataavailable=I=>{I.data.size>0&&f.current.push(I.data)},u.current.onstop=()=>{const I=new Blob(f.current,{type:"audio/webm"});i(I),C.getTracks().forEach(U=>U.stop())},u.current.start(),c(!0),o(0),h.current=setInterval(()=>{o(I=>I+1)},1e3)}catch(C){console.error("Error accessing microphone:",C),v({title:"Microphone Error",description:"Could not access microphone. Please check permissions.",variant:"destructive"})}},y=()=>{u.current&&a&&(u.current.stop(),c(!1),h.current&&clearInterval(h.current))},k=()=>{y(),i(null),o(0)},p=()=>{if(d){if(!x.current){const C=URL.createObjectURL(d);x.current=new Audio(C),x.current.onended=()=>r(!1)}x.current.play(),r(!0)}},g=()=>{x.current&&(x.current.pause(),r(!1))},b=()=>{if(!d)return;const C=new File([d],`voice-message-${Date.now()}.webm`,{type:"audio/webm"});s(C),i(null),o(0)},N=C=>{const I=Math.floor(C/60),U=C%60;return`${I}:${U.toString().padStart(2,"0")}`};return d?e.jsxs("div",{className:"flex items-center gap-2 p-1 bg-muted rounded-lg animate-in fade-in slide-in-from-bottom-2",children:[e.jsx(_,{type:"button",variant:"ghost",size:"sm",onClick:m?g:p,className:"h-8 w-8 p-0",children:m?e.jsx(Hr,{className:"h-4 w-4"}):e.jsx(Kr,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs font-mono",children:N(l)}),e.jsx(_,{type:"button",variant:"ghost",size:"sm",onClick:k,className:"h-8 w-8 p-0 text-destructive hover:text-destructive",children:e.jsx(ea,{className:"h-4 w-4"})}),e.jsxs(_,{type:"button",size:"sm",onClick:b,className:"h-8 px-3",children:[e.jsx(Ms,{className:"h-3 w-3 mr-2"}),"Send"]})]}):e.jsx(_,{type:"button",variant:"ghost",size:"sm",className:`h-8 w-8 p-0 transition-all duration-300 ${a?"bg-destructive/10 text-destructive animate-pulse":""}`,onClick:a?y:j,disabled:t,title:a?"Stop recording":"Record voice message",children:a?e.jsx(Jr,{className:"h-4 w-4"}):e.jsx(Gr,{className:"h-4 w-4"})})},Fi=s=>{const{user:t}=J(),{botStatus:a}=As(),[c,l]=n.useState(""),[o,d]=n.useState([]),[i,m]=n.useState(!1),r=n.useCallback(f=>{if(l(f),f.length<1){d([]);return}m(!0);const h=f.toLowerCase();let x=[];"bot".includes(h)&&a.isOnline&&x.push({id:"bot",name:"bot",isMember:!1,displayName:"@bot (AI Assistant)"});const v=s.filter(j=>{var k;const y=((k=t==null?void 0:t.user_metadata)==null?void 0:k.name)||(t==null?void 0:t.email)||"";return j.name===y?!1:j.name.toLowerCase().includes(h)}).map(j=>({id:j.key,name:j.name,isMember:j.isMember,displayName:j.name}));x=[...x,...v].slice(0,8),d(x),m(!1)},[s,t]),u=n.useCallback(()=>{d([]),l("")},[]);return{searchQuery:c,searchUsers:r,suggestions:o,isLoading:i,clearSuggestions:u}},Oi=()=>{const{toast:s}=ee(),[t,a]=n.useState(!1),c=[{name:"help",description:"Show available slash commands",usage:"/help [command]",handler:async i=>{if(i.length>0){const r=c.find(u=>u.name===i[0]);return r?`**${r.name}**: ${r.description}
Usage: \`${r.usage}\``:`Command "${i[0]}" not found. Use \`/help\` to see all commands.`}return`**Available Commands:**
${c.map(r=>`**/${r.name}** - ${r.description}`).join(`
`)}

Use \`/help [command]\` for detailed usage.`}},{name:"shrug",description:"Add a shrug emoticon",usage:"/shrug [text]",handler:async i=>{const m=i.join(" ");return m?`${m} ¬Ø\\_(„ÉÑ)_/¬Ø`:"¬Ø\\_(„ÉÑ)_/¬Ø"}},{name:"flip",description:"Flip text upside down",usage:"/flip <text>",handler:async i=>{if(i.length===0)return"Usage: `/flip <text>` - Please provide text to flip.";const m={a:"…ê",b:"q",c:"…î",d:"p",e:"«ù",f:"…ü",g:"∆É",h:"…•",i:"·¥â",j:"…æ",k:" û",l:"l",m:"…Ø",n:"u",o:"o",p:"d",q:"b",r:"…π",s:"s",t:" á",u:"n",v:" å",w:" ç",x:"x",y:" é",z:"z","?":"¬ø","!":"¬°",".":"Àô",",":"'"," ":" "};return`(‚ïØ¬∞‚ñ°¬∞Ôºâ‚ïØÔ∏µ ${i.join(" ").toLowerCase().split("").map(f=>m[f]||f).reverse().join("")}`}},{name:"roll",description:"Roll dice",usage:"/roll [XdY] (default: 1d6)",handler:async i=>{const m=/^(\d+)?d(\d+)$/i,r=i[0]||"1d6",u=r.match(m);if(!u)return"Usage: `/roll [XdY]` - Example: `/roll 2d6` or just `/roll` for 1d6";const f=parseInt(u[1]||"1"),h=parseInt(u[2]);if(f>10)return"Maximum 10 dice allowed.";if(h>100)return"Maximum 100 sides allowed.";const x=[];for(let y=0;y<f;y++)x.push(Math.floor(Math.random()*h)+1);const v=x.reduce((y,k)=>y+k,0),j=x.join(", ");return f===1?`üé≤ Rolled ${r}: **${v}**`:`üé≤ Rolled ${r}: [${j}] = **${v}**`}},{name:"time",description:"Show current time",usage:"/time",handler:async()=>`üïê Current time: **${new Date().toLocaleString()}**`}],l=n.useCallback(i=>{if(!i.startsWith("/"))return null;const m=i.slice(1).split(" "),r=m[0].toLowerCase(),u=m.slice(1),f=c.find(h=>h.name===r);return f?{command:f,args:u}:null},[c]),o=n.useCallback(async i=>{const m=l(i);if(!m)return null;a(!0);try{return await m.command.handler(m.args)}catch(r){return console.error("Slash command error:",r),s({title:"Command Error",description:"Failed to execute command. Please try again.",variant:"destructive"}),null}finally{a(!1)}},[l,s]),d=n.useCallback(i=>{if(!i.startsWith("/"))return[];const m=i.slice(1).toLowerCase();return c.filter(r=>r.name.startsWith(m)).slice(0,5).map(r=>({name:`/${r.name}`,description:r.description,usage:r.usage}))},[c]);return{commands:c,executeSlashCommand:o,getSuggestions:d,isProcessing:t,isSlashCommand:i=>i.startsWith("/")}},qi=({onSendMessage:s,disabled:t=!1,placeholder:a="Type a message...",onlineUsers:c=[],mentionToAdd:l,onMentionAdded:o,onSlashCommand:d})=>{const[i,m]=n.useState(""),[r,u]=n.useState(!1),[f,h]=n.useState(-1),[x,v]=n.useState(0),[j,y]=n.useState(0),[k,p]=n.useState(!1),[g,b]=n.useState(""),[N,C]=n.useState(-1),[I,U]=n.useState(0),[q,Y]=n.useState(!1),[ie,me]=n.useState(0),[he,oe]=n.useState([]),H=n.useRef(null),{toast:se}=ee(),{validateAndSanitizeMessage:xe}=aa(),{suggestions:ue,searchUsers:Ue,clearSuggestions:fe}=Fi(c),{executeSlashCommand:_e,getSuggestions:w,isSlashCommand:L}=Oi(),{uploadFile:$}=Ir(),M=1e3,F=(A,D)=>{const K=A.slice(0,D),O=K.lastIndexOf("@");if(O===-1){u(!1),fe();return}const te=K.slice(O+1);if(te.includes(" ")){u(!1),fe();return}h(O),u(!0),Ue(te)},W=(A,D)=>{const K=A.slice(0,D),O=K.lastIndexOf(":");if(O===-1){p(!1),b("");return}const te=K.slice(O+1);if(te.includes(" ")||te.includes(":")){p(!1),b("");return}C(O),b(te),p(!0)},ae=A=>{const D=A.target.value,K=A.target.selectionStart||0;if(m(D),y(K),D.startsWith("/")){const O=w(D);Y(O.length>0),u(!1),p(!1)}else Y(!1),F(D,K),W(D,K)},Z=A=>{if(f===-1)return;const D=i.slice(0,f),K=i.slice(j),O=Mt(A.name),te=D+O+" "+K,cs=D.length+O.length+1;m(te),u(!1),fe(),h(-1),setTimeout(()=>{H.current&&(H.current.focus(),H.current.setSelectionRange(cs,cs))},0)},ge=async()=>{const A=i.trim();if(!A&&he.length===0){se({title:"Empty message",description:"Please enter a message or attach a file to send.",variant:"destructive"});return}if(L(A)){const D=await _e(A);if(D){s(D),m(""),oe([]);return}}if(A.length>M){se({title:"Message too long",description:`Message must be ${M} characters or less.`,variant:"destructive"});return}if(A){const D=await xe(A);if(!D.isValid)return;const{content:K}=Fa(D.sanitized),{content:O,mentions:te}=oi(K);t||(s(O,te,he),m(""),oe([]),u(!1),p(!1),Y(!1),fe())}else he.length>0&&(t||(s("",[],he),m(""),oe([]),u(!1),p(!1),Y(!1),fe()))},os=A=>{if(N===-1)return;const D=i.slice(0,N),K=i.slice(j),O=D+A.emoji+" "+K,te=D.length+A.emoji.length+1;m(O),p(!1),b(""),C(-1),setTimeout(()=>{H.current&&(H.current.focus(),H.current.setSelectionRange(te,te))},0)},Xe=A=>{if(k){if(A.key==="ArrowDown"){A.preventDefault(),U(D=>D<7?D+1:0);return}if(A.key==="ArrowUp"){A.preventDefault(),U(D=>D>0?D-1:7);return}if(A.key==="Enter"&&I>=0){A.preventDefault();return}if(A.key==="Escape"){A.preventDefault(),p(!1),b("");return}}if(r&&ue.length>0){if(A.key==="ArrowDown"){A.preventDefault(),v(D=>D<ue.length-1?D+1:0);return}if(A.key==="ArrowUp"){A.preventDefault(),v(D=>D>0?D-1:ue.length-1);return}if(A.key==="Enter"&&x>=0){A.preventDefault(),Z(ue[x]);return}if(A.key==="Escape"){A.preventDefault(),u(!1),fe();return}}A.key==="Enter"&&!A.shiftKey&&(A.preventDefault(),ge())},Fe=()=>{if(H.current){const A=H.current.selectionStart||0;y(A),F(i,A)}};n.useEffect(()=>{v(0)},[ue]),n.useEffect(()=>{if(l){const A=Mt(l),D=i?`${i} ${A} `:`${A} `;m(D),o==null||o(),setTimeout(()=>{H.current&&(H.current.focus(),H.current.setSelectionRange(D.length,D.length))},0)}},[l,i,o]);const Oe=()=>{if(!H.current||f===-1)return{top:0,left:0};const D=H.current.getBoundingClientRect(),O=f*8;return{top:D.top-10,left:D.left+O+12}},ls=()=>{if(!H.current||N===-1)return{top:0,left:0};const D=H.current.getBoundingClientRect(),O=N*8;return{top:D.top-10,left:D.left+O+12}},Me=M-i.length,Ae=Me<=100;return e.jsxs("div",{className:"border-t border-border p-3 md:p-4 relative",children:[e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(ce,{ref:H,value:i,onChange:ae,onKeyDown:Xe,onClick:Fe,onKeyUp:Fe,placeholder:t?a:"Type a message... (Use @bot for AI help)",disabled:t,className:"chat-input pr-16 h-12 md:h-10 text-base md:text-sm",maxLength:M,"aria-label":"Type your message. Use @bot to chat with AI, @ to mention users","aria-describedby":Ae?"char-count":void 0,autoComplete:"off"}),Ae&&e.jsx("div",{id:"char-count",className:`absolute right-2 top-1/2 -translate-y-1/2 text-xs ${Me<=50?"text-destructive":"text-muted-foreground"}`,"aria-live":"polite",children:Me})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ui,{onAudioRecorded:async A=>{try{const D=await $(A);D&&(s("",[],[D]),se({title:"Voice message sent",description:"Your voice message has been sent."}))}catch(D){console.error("Failed to upload voice message",D)}},disabled:t}),e.jsx(Tr,{onFileUploaded:A=>{oe(D=>[...D,A]),se({title:"File attached",description:`${A.name} has been attached to your message.`})},disabled:t}),e.jsx(_,{onClick:ge,disabled:!i.trim()&&he.length===0||t||i.length>M,className:"h-12 md:h-10 px-4 md:px-3 min-w-[48px]","aria-label":"Send message",children:e.jsx(Ms,{className:"w-5 h-5 md:w-4 md:h-4","aria-hidden":"true"})})]})]}),he.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:he.map((A,D)=>e.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-muted rounded text-sm",children:[e.jsx("span",{className:"truncate max-w-[200px]",children:A.name}),e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>oe(K=>K.filter((O,te)=>te!==D)),className:"h-4 w-4 p-0 text-muted-foreground hover:text-destructive",children:"√ó"})]},D))}),e.jsx(di,{suggestions:ue,selectedIndex:x,onSelect:Z,onHover:v,position:Oe(),visible:r&&ue.length>0}),e.jsx(mi,{visible:k,query:g,position:ls(),onSelect:os,onClose:()=>{p(!1),b("")},selectedIndex:I,onHover:U}),e.jsx(Bi,{suggestions:w(i),onSelect:A=>{m(A+" "),Y(!1),H.current&&(H.current.focus(),setTimeout(()=>{var K;const D=A.length+1;(K=H.current)==null||K.setSelectionRange(D,D)},0))},isVisible:q})]})},Vi=({messageId:s,replyCount:t=0,onStartReply:a,onToggleThread:c,isThreadOpen:l=!1,className:o=""})=>e.jsxs("div",{className:`flex items-center gap-1 ${o}`,children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>a(s),className:"h-7 px-2 text-muted-foreground hover:text-foreground",title:"Reply to this message",children:e.jsx(Te,{className:"w-3.5 h-3.5"})}),t>0&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>c(s),className:"h-7 px-2 text-muted-foreground hover:text-foreground flex items-center gap-1",title:`${t} ${t===1?"reply":"replies"}`,children:[e.jsx(Er,{className:`w-3.5 h-3.5 transition-transform ${l?"rotate-90":""}`}),e.jsx("span",{className:"text-xs",children:t})]})]}),Gi=({parentMessageId:s,onSendReply:t,onCancel:a,placeholder:c="Reply to this message..."})=>{const[l,o]=n.useState(""),[d,i]=n.useState(!1),m=async u=>{if(u.preventDefault(),!l.trim()||d)return;i(!0),await t(l,s)&&o(""),i(!1)},r=u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),m(u)),u.key==="Escape"&&a()};return e.jsx("div",{className:"mt-2 p-3 bg-muted/30 rounded-lg border border-border/50",children:e.jsxs("form",{onSubmit:m,className:"space-y-2",children:[e.jsx("div",{className:"relative",children:e.jsx(mt,{value:l,onChange:u=>o(u.target.value),onKeyDown:r,placeholder:c,className:"min-h-[60px] pr-12 resize-none",autoFocus:!0})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Press Enter to send, Shift+Enter for new line, Esc to cancel"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_,{type:"button",variant:"ghost",size:"sm",onClick:a,className:"h-8",children:[e.jsx(as,{className:"w-4 h-4 mr-1"}),"Cancel"]}),e.jsxs(_,{type:"submit",size:"sm",disabled:!l.trim()||d,className:"h-8",children:[e.jsx(Ms,{className:"w-4 h-4 mr-1"}),"Reply"]})]})]})]})})},Hi=({partner:s,onClose:t})=>{const{user:a}=J(),{toast:c}=ee(),{markMessagesAsRead:l}=na(),[o,d]=n.useState([]),[i,m]=n.useState(""),[r,u]=n.useState(!0),[f,h]=n.useState(!1),x=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{if(!a)return;(async()=>{u(!0);try{const{data:b,error:N}=await E.from("private_messages").select("*").or(`and(sender_id.eq.${a.id},receiver_id.eq.${s.id}),and(sender_id.eq.${s.id},receiver_id.eq.${a.id})`).order("created_at",{ascending:!0});if(N)throw N;d(b||[]),await l(s.id)}catch(b){c({title:"Failed to load messages",description:b.message,variant:"destructive"})}finally{u(!1)}})();const g=E.channel(`private-chat-${a.id}-${s.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"private_messages",filter:`or(and(sender_id.eq.${a.id},receiver_id.eq.${s.id}),and(sender_id.eq.${s.id},receiver_id.eq.${a.id}))`},b=>{const N=b.new;d(C=>[...C,N]),N.sender_id===s.id&&l(s.id)}).subscribe();return v.current=g,()=>{v.current&&E.removeChannel(v.current)}},[a,s.id]),n.useEffect(()=>{var p;(p=x.current)==null||p.scrollIntoView({behavior:"smooth"})},[o]);const j=async()=>{var p;if(!(!i.trim()||!a||f)){h(!0);try{const{error:g}=await E.from("private_messages").insert({content:i.trim(),sender_id:a.id,receiver_id:s.id,sender_name:((p=a.user_metadata)==null?void 0:p.name)||a.email,receiver_name:s.name});if(g)throw g;m("")}catch(g){c({title:"Failed to send message",description:g.message,variant:"destructive"})}finally{h(!1)}}},y=p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),j())},k=p=>{const g=new Date(p),b=new Date;return g.toDateString()===b.toDateString()?g.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):g.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})};return a?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-2xl h-[80vh] flex flex-col bg-background border border-border rounded-lg overflow-hidden neon-bg neon-border animate-scale-in",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border chat-header",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:t,className:"p-2",children:e.jsx(Lr,{className:"w-4 h-4"})}),e.jsx(Ye,{className:"w-8 h-8",children:e.jsx(Ke,{className:"text-sm",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Private conversation"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"ghost",size:"sm",className:"p-2",children:e.jsx(Yr,{className:"w-4 h-4"})}),e.jsx(_,{variant:"ghost",size:"sm",className:"p-2",children:e.jsx(en,{className:"w-4 h-4"})}),e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"sm",className:"p-2",children:e.jsx(Rs,{className:"w-4 h-4"})})}),e.jsxs(Be,{align:"end",children:[e.jsxs(Q,{children:[e.jsx(qr,{className:"w-4 h-4 mr-2"}),"User Info"]}),e.jsx(Q,{className:"text-destructive",children:"Block User"})]})]})]})]}),e.jsx(be,{className:"flex-1 p-4",children:r?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"text-muted-foreground",children:"Loading messages..."})}):o.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx("p",{className:"text-lg font-medium mb-2",children:"Start the conversation"}),e.jsxs("p",{className:"text-sm",children:["Send a message to ",s.name]})]})}):e.jsxs("div",{className:"space-y-4",children:[o.map(p=>{var b;const g=p.sender_id===a.id;return e.jsxs("div",{className:`flex gap-3 animate-fade-in ${g?"flex-row-reverse":"flex-row"}`,children:[e.jsx(Ye,{className:"w-8 h-8 flex-shrink-0",children:e.jsx(Ke,{className:"text-xs",children:g?(((b=a.user_metadata)==null?void 0:b.name)||a.email).charAt(0).toUpperCase():s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:`max-w-[70%] ${g?"items-end":"items-start"} flex flex-col`,children:[e.jsx("div",{className:`
                        px-4 py-2 rounded-lg
                        ${g?"chat-bubble-own rounded-br-sm":"chat-bubble-other rounded-bl-sm"}
                        neon-border
                      `,children:e.jsx("div",{className:"text-sm leading-relaxed break-words",children:p.content})}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1 px-1",children:k(p.created_at)})]})]},p.id)}),e.jsx("div",{ref:x})]})}),e.jsx("div",{className:"border-t border-border p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ce,{value:i,onChange:p=>m(p.target.value),onKeyDown:y,placeholder:`Message ${s.name}...`,disabled:f,className:"flex-1 chat-input"}),e.jsx(_,{onClick:j,disabled:!i.trim()||f,size:"sm",children:f?e.jsx("div",{className:"w-4 h-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):e.jsx(Ms,{className:"w-4 h-4"})})]})})]})}):null},Wi=({onClose:s})=>{const{user:t}=J(),{toast:a}=ee(),[c,l]=n.useState(!1),[o,d]=n.useState({email:"",password:""}),[i,m]=n.useState({email:"",password:"",name:""});if(t)return s(),null;const r=async h=>{h.preventDefault(),l(!0);try{const{error:x}=await E.auth.signInWithPassword({email:o.email,password:o.password});if(x)throw x;a({title:"Welcome back!",description:"You have successfully logged in."}),s()}catch(x){a({title:"Login failed",description:x.message,variant:"destructive"})}finally{l(!1)}},u=async h=>{h.preventDefault(),l(!0);try{const{error:x}=await E.auth.signUp({email:i.email,password:i.password,options:{emailRedirectTo:`${window.location.origin}/`,data:{name:i.name||i.email.split("@")[0]}}});if(x)throw x;a({title:"Account created!",description:"Please check your email to verify your account."})}catch(x){a({title:"Signup failed",description:x.message,variant:"destructive"})}finally{l(!1)}},f=async h=>{var x;try{const{error:v}=await E.auth.signInWithOAuth({provider:h,options:{redirectTo:`${window.location.origin}/`}});if(v)throw v}catch(v){let j=v.message,y=`${h.charAt(0).toUpperCase()+h.slice(1)} login failed`;((x=v.message)!=null&&x.includes("provider is not enabled")||v.code===400)&&(j=`${h.charAt(0).toUpperCase()+h.slice(1)} login is not enabled. Please contact the administrator.`,y="Configuration Required"),a({title:y,description:j,variant:"destructive"})}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:e.jsxs(ss,{className:"w-full max-w-md neon-bg neon-border",children:[e.jsxs(ot,{className:"relative",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:s,className:"absolute right-0 top-0 h-8 w-8 p-0",children:e.jsx(as,{className:"w-4 h-4"})}),e.jsx(lt,{className:"text-xl font-bold neon-glow",children:"Welcome to IMAIET"}),e.jsx(ct,{children:"Sign in to your account or create a new one to access private messaging."})]}),e.jsxs(dt,{children:[e.jsxs(_s,{defaultValue:"login",className:"space-y-4",children:[e.jsxs(Ss,{className:"grid w-full grid-cols-2",children:[e.jsx(je,{value:"login",children:"Login"}),e.jsx(je,{value:"signup",children:"Sign Up"})]}),e.jsx(we,{value:"login",children:e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"login-email",children:"Email"}),e.jsxs("div",{className:"relative",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{id:"login-email",type:"email",placeholder:"you@example.com",value:o.email,onChange:h=>d({...o,email:h.target.value}),className:"pl-10",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"login-password",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{id:"login-password",type:"password",placeholder:"Your password",value:o.password,onChange:h=>d({...o,password:h.target.value}),className:"pl-10",required:!0})]})]}),e.jsx(_,{type:"submit",className:"w-full",disabled:c,children:c?"Logging in...":"Log In"})]})}),e.jsx(we,{value:"signup",children:e.jsxs("form",{onSubmit:u,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"signup-name",children:"Display Name"}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{id:"signup-name",type:"text",placeholder:"Your display name",value:i.name,onChange:h=>m({...i,name:h.target.value}),className:"pl-10"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"signup-email",children:"Email"}),e.jsxs("div",{className:"relative",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{id:"signup-email",type:"email",placeholder:"you@example.com",value:i.email,onChange:h=>m({...i,email:h.target.value}),className:"pl-10",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"signup-password",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{id:"signup-password",type:"password",placeholder:"Choose a password",value:i.password,onChange:h=>m({...i,password:h.target.value}),className:"pl-10",required:!0})]})]}),e.jsx(_,{type:"submit",className:"w-full",disabled:c,children:c?"Creating account...":"Sign Up"})]})})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t border-border"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-background px-2 text-muted-foreground",children:"Or continue with"})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-3 gap-2",children:[e.jsx(_,{variant:"outline",onClick:()=>f("google"),className:"w-full","aria-label":"Google",children:e.jsxs("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z",fill:"#4285F4"}),e.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z",fill:"#34A853"}),e.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z",fill:"#FBBC05"}),e.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z",fill:"#EA4335"})]})}),e.jsx(_,{variant:"outline",onClick:()=>f("github"),className:"w-full","aria-label":"GitHub",children:e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"})})}),e.jsx(_,{variant:"outline",onClick:()=>f("facebook"),className:"w-full","aria-label":"Facebook",children:e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"#1877F2",children:e.jsx("path",{d:"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"})})})]})]})]})]})})},Yi=({onClose:s})=>{const{toast:t}=ee(),a="3FV6kFsNTXEzPpLKKG5SrChXdgGSSNFN9P",c="0xe527C13F23799e5a7d038B70765128c5e928f07d",l=(d,i)=>{navigator.clipboard.writeText(d),t({title:"Copied!",description:`${i} address copied to clipboard.`})},o=({data:d,alt:i})=>e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(d)}`,alt:i,className:"border border-border rounded-lg",loading:"lazy",width:"150",height:"150"})});return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-start justify-center z-50 p-4 overflow-y-auto",children:e.jsx("div",{className:"w-full max-w-md min-h-screen sm:min-h-0 sm:my-8 flex items-start sm:items-center",children:e.jsxs(ss,{className:"w-full max-h-[90vh] sm:max-h-[80vh] neon-bg neon-border flex flex-col",children:[e.jsxs(ot,{className:"relative flex-shrink-0",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:s,className:"absolute right-2 top-2 h-8 w-8 p-0 z-10",children:e.jsx(as,{className:"w-4 h-4"})}),e.jsxs(lt,{className:"text-xl font-bold neon-glow flex items-center gap-2 pr-10",children:[e.jsx(Ur,{className:"w-5 h-5"}),"Support IMAIET"]}),e.jsx(ct,{children:"Help keep IMAIET running by making a donation. Every contribution helps!"})]}),e.jsxs(dt,{className:"flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pr,{className:"w-5 h-5 text-orange-500"}),e.jsx("h3",{className:"font-semibold",children:"Bitcoin (BTC)"})]}),e.jsx(o,{data:a,alt:"Bitcoin QR Code"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"flex-1 bg-muted p-2 rounded text-xs break-all",children:a}),e.jsx(_,{variant:"outline",size:"sm",onClick:()=>l(a,"Bitcoin"),children:e.jsx(Os,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold",children:"Œû"}),e.jsx("h3",{className:"font-semibold",children:"Ethereum (ETH)"})]}),e.jsx(o,{data:c,alt:"Ethereum QR Code"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"flex-1 bg-muted p-2 rounded text-xs break-all",children:c}),e.jsx(_,{variant:"outline",size:"sm",onClick:()=>l(c,"Ethereum"),children:e.jsx(Os,{className:"w-4 h-4"})})]})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("p",{className:"text-xs text-muted-foreground",children:"Thank you for supporting open communication! üí¨"})})]})]})})})},Ki=({onClose:s,onMessageClick:t})=>{const{bookmarks:a,isLoading:c,removeBookmark:l}=Ba(),[o,d]=n.useState(""),i=a.filter(u=>u.message.content.toLowerCase().includes(o.toLowerCase())||u.message.sender_name.toLowerCase().includes(o.toLowerCase())),m=async u=>{await l(u)},r=u=>fs(new Date(u),{addSuffix:!0});return e.jsxs(ss,{className:"w-full max-w-2xl h-[600px] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Bookmarked Messages"}),e.jsxs(le,{variant:"secondary",children:[a.length," ",a.length===1?"bookmark":"bookmarks"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Search bookmarks...",value:o,onChange:u=>d(u.target.value),className:"pl-9"})]})]}),e.jsx(be,{className:"flex-1 p-4",children:c?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading bookmarks..."})}):i.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-center",children:[e.jsx(Te,{className:"w-8 h-8 text-muted-foreground mb-2"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:o?"No bookmarks match your search":"No bookmarked messages yet"}),o&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>d(""),className:"mt-2",children:"Clear search"})]}):e.jsx("div",{className:"space-y-4",children:i.map(u=>e.jsxs(ss,{className:"p-4 hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium",children:u.message.sender_name}),e.jsx(Ar,{className:"w-3 h-3"}),e.jsx("span",{children:r(u.message.created_at)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[t&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>t(u.message_id),className:"h-6 w-6 p-0",title:"Go to message",children:e.jsx(Or,{className:"w-3 h-3"})}),e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>m(u.message_id),className:"h-6 w-6 p-0 text-muted-foreground hover:text-destructive",title:"Remove bookmark",children:e.jsx($r,{className:"w-3 h-3"})})]})]}),e.jsx("div",{className:"text-sm",children:e.jsx(Oa,{content:u.message.content,mentions:u.message.mentions||[],className:"text-sm"})}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-border text-xs text-muted-foreground",children:["Bookmarked ",r(u.created_at)]})]},u.id))})}),s&&e.jsxs(e.Fragment,{children:[e.jsx(Bs,{}),e.jsx("div",{className:"p-4",children:e.jsx(_,{onClick:s,className:"w-full",children:"Close"})})]})]})},Zs=()=>{const{user:s}=J(),[t,a]=n.useState([]),[c,l]=n.useState(!0),o=n.useCallback(async()=>{if(!s){a([]),l(!1);return}try{const{data:f,error:h}=await E.from("contacts").select("*").eq("user_id",s.id).order("created_at",{ascending:!1});if(h)throw h;if(f&&f.length>0){const x=f.map(k=>k.contact_user_id),{data:v,error:j}=await E.from("profiles").select("user_id, username, display_name, avatar_url, status").in("user_id",x);j&&console.error("Error fetching profiles:",j);const y=f.map(k=>({...k,contact_profile:(v==null?void 0:v.find(p=>p.user_id===k.contact_user_id))||void 0}));a(y)}else a([]);l(!1)}catch(f){console.error("Error fetching contacts:",f),l(!1)}},[s]);return n.useEffect(()=>{o()},[o]),{contacts:t,isLoading:c,addContact:async(f,h)=>{if(!s)return V.error("You must be logged in to add contacts"),!1;if(f===s.id)return V.error("You can't add yourself as a contact"),!1;try{const{data:x,error:v}=await E.from("contacts").insert({user_id:s.id,contact_user_id:f,nickname:(h==null?void 0:h.trim())||null}).select().single();if(v)throw v;const{data:j}=await E.from("profiles").select("user_id, username, display_name, avatar_url, status").eq("user_id",f).single(),y={...x,contact_profile:j||void 0};return a(k=>[y,...k]),V.success("Contact added successfully!"),!0}catch(x){return console.error("Error adding contact:",x),x.code==="23505"?V.error("This user is already in your contacts"):V.error("Failed to add contact"),!1}},removeContact:async f=>{if(!s)return!1;try{const{error:h}=await E.from("contacts").delete().eq("id",f).eq("user_id",s.id);if(h)throw h;return a(x=>x.filter(v=>v.id!==f)),V.success("Contact removed successfully!"),!0}catch(h){return console.error("Error removing contact:",h),V.error("Failed to remove contact"),!1}},updateNickname:async(f,h)=>{if(!s)return!1;try{const{error:x}=await E.from("contacts").update({nickname:h.trim()||null}).eq("id",f).eq("user_id",s.id);if(x)throw x;return a(v=>v.map(j=>j.id===f?{...j,nickname:h.trim()||void 0}:j)),V.success("Nickname updated!"),!0}catch(x){return console.error("Error updating nickname:",x),V.error("Failed to update nickname"),!1}},isContact:f=>t.some(h=>h.contact_user_id===f),searchUsers:async f=>{if(!s||!f.trim())return[];try{const{data:h,error:x}=await E.from("profiles").select("user_id, username, display_name, avatar_url").or(`username.ilike.%${f}%,display_name.ilike.%${f}%`).neq("user_id",s.id).limit(10);if(x)throw x;return h||[]}catch(h){return console.error("Error searching users:",h),[]}},refreshContacts:o}},Qi=({open:s,onOpenChange:t,roomId:a,roomName:c,existingMemberIds:l,onMemberAdded:o})=>{const{contacts:d}=Zs(),{searchUsers:i}=Zs(),{addMember:m}=ns(),[r,u]=n.useState(""),[f,h]=n.useState([]),[x,v]=n.useState(!1),[j,y]=n.useState(new Set),k=d.filter(N=>!l.includes(N.contact_user_id)),p=async N=>{if(u(N),N.trim().length<2){h([]);return}v(!0);const I=(await i(N)).filter(U=>!l.includes(U.user_id));h(I),v(!1)},g=async(N,C)=>{y(U=>new Set(U).add(N));const I=await m(a,N);y(U=>{const q=new Set(U);return q.delete(N),q}),I&&(V.success(`${C} added to ${c}`),o==null||o(),h(U=>U.filter(q=>q.user_id!==N)))},b=()=>{u(""),h([]),t(!1)};return e.jsx(vs,{open:s,onOpenChange:b,children:e.jsxs(js,{className:"sm:max-w-[500px]",children:[e.jsxs(ws,{children:[e.jsxs(bs,{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5"}),"Add Members to ",c]}),e.jsx(Ns,{children:"Add members from your contacts or search for users"})]}),e.jsxs(_s,{defaultValue:"contacts",className:"w-full",children:[e.jsxs(Ss,{className:"grid w-full grid-cols-2",children:[e.jsx(je,{value:"contacts",children:"Contacts"}),e.jsx(je,{value:"search",children:"Search Users"})]}),e.jsx(we,{value:"contacts",className:"space-y-4",children:e.jsx(be,{className:"h-[300px] pr-4",children:k.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-40 text-muted-foreground text-sm",children:[e.jsx("p",{children:"No available contacts"}),e.jsx("p",{className:"text-xs mt-1",children:"All contacts are already members"})]}):e.jsx("div",{className:"space-y-2",children:k.map(N=>{var I,U,q,Y;const C=N.nickname||((I=N.contact_profile)==null?void 0:I.display_name)||((U=N.contact_profile)==null?void 0:U.username)||"User";return e.jsx(Tt,{userId:N.contact_user_id,displayName:C,username:(q=N.contact_profile)==null?void 0:q.username,avatarUrl:(Y=N.contact_profile)==null?void 0:Y.avatar_url,isAdding:j.has(N.contact_user_id),onAdd:()=>g(N.contact_user_id,C)},N.id)})})})}),e.jsxs(we,{value:"search",className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Search by username...",value:r,onChange:N=>p(N.target.value),className:"pl-10","aria-label":"Search users"})]}),e.jsx(be,{className:"h-[250px] pr-4",children:x?e.jsx("div",{className:"flex items-center justify-center h-20",children:e.jsx(Le,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):f.length>0?e.jsx("div",{className:"space-y-2",children:f.map(N=>e.jsx(Tt,{userId:N.user_id,displayName:N.display_name||N.username||"User",username:N.username,avatarUrl:N.avatar_url,isAdding:j.has(N.user_id),onAdd:()=>g(N.user_id,N.display_name||N.username||"User")},N.user_id))}):r.length>=2?e.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-sm",children:"No users found"}):e.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-sm",children:"Enter at least 2 characters to search"})})]})]}),e.jsx(ks,{children:e.jsx(_,{variant:"outline",onClick:b,children:"Done"})})]})})},Tt=({displayName:s,username:t,avatarUrl:a,isAdding:c,onAdd:l})=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(Ye,{className:"h-8 w-8",children:[e.jsx(Cs,{src:a}),e.jsx(Ke,{children:s[0].toUpperCase()})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s}),t&&s!==t&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["@",t]})]})]}),e.jsx(_,{size:"sm",variant:"outline",onClick:l,disabled:c,className:"h-8",children:c?e.jsx(Le,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"h-4 w-4 mr-1"}),"Add"]})})]}),Xi=({roomId:s,roomName:t})=>{const{user:a}=J(),{isRoomAdmin:c,removeMember:l}=ns(),[o,d]=n.useState([]),[i,m]=n.useState(!0),[r,u]=n.useState(!1),f=c(s),h=async()=>{m(!0);try{const{data:p,error:g}=await E.from("group_members").select("*").eq("channel_id",s).order("joined_at",{ascending:!0});if(g)throw g;if(p&&p.length>0){const b=p.map(I=>I.user_id),{data:N}=await E.from("profiles").select("user_id, username, display_name, avatar_url, status").in("user_id",b),C=p.map(I=>({...I,profile:N==null?void 0:N.find(U=>U.user_id===I.user_id)}));d(C)}else d([])}catch(p){console.error("Error fetching members:",p),V.error("Failed to load group members")}finally{m(!1)}};n.useEffect(()=>{h();const p=E.channel(`group-members:${s}`).on("postgres_changes",{event:"*",schema:"public",table:"group_members",filter:`channel_id=eq.${s}`},()=>{h()}).subscribe();return()=>{E.removeChannel(p)}},[s]);const x=async(p,g)=>{if(g===(a==null?void 0:a.id)){V.error("You can't remove yourself. Use leave room instead.");return}await l(s,g)&&d(N=>N.filter(C=>C.id!==p))},v=async(p,g)=>{const b=g==="member"?"moderator":"admin";try{const{error:N}=await E.from("group_members").update({role:b}).eq("channel_id",s).eq("user_id",p);if(N)throw N;V.success(`Member promoted to ${b}`),h()}catch(N){console.error("Error promoting member:",N),V.error("Failed to promote member")}},j=async p=>{try{const{error:g}=await E.from("group_members").update({role:"member"}).eq("channel_id",s).eq("user_id",p);if(g)throw g;V.success("Member demoted"),h()}catch(g){console.error("Error demoting member:",g),V.error("Failed to demote member")}},y=p=>{switch(p){case"admin":return e.jsx(Es,{className:"h-3 w-3 text-yellow-500"});case"moderator":return e.jsx(ps,{className:"h-3 w-3 text-blue-500"});default:return null}},k=p=>{switch(p){case"admin":return"default";case"moderator":return"secondary";default:return"outline"}};return e.jsxs("div",{className:"flex flex-col h-full border-l border-border",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("h3",{className:"font-semibold text-sm",children:["Members (",o.length,")"]})]}),f&&e.jsx(_,{size:"sm",variant:"ghost",onClick:()=>u(!0),"aria-label":"Add member",children:e.jsx(Ie,{className:"h-4 w-4"})})]}),e.jsx(be,{className:"flex-1",children:i?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(Le,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):o.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground text-sm",children:"No members yet"}):e.jsx("div",{className:"p-2 space-y-1",children:o.map(p=>e.jsx(Ji,{member:p,isCurrentUser:p.user_id===(a==null?void 0:a.id),isAdmin:f,onRemove:()=>x(p.id,p.user_id),onPromote:()=>v(p.user_id,p.role||"member"),onDemote:()=>j(p.user_id),getRoleIcon:y,getRoleBadgeVariant:k},p.id))})}),e.jsx(Qi,{open:r,onOpenChange:u,roomId:s,roomName:t,existingMemberIds:o.map(p=>p.user_id),onMemberAdded:h})]})},Ji=({member:s,isCurrentUser:t,isAdmin:a,onRemove:c,onPromote:l,onDemote:o,getRoleIcon:d,getRoleBadgeVariant:i})=>{var u,f,h,x;const m=((u=s.profile)==null?void 0:u.display_name)||((f=s.profile)==null?void 0:f.username)||"User",r=s.role||"member";return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(Ye,{className:"h-8 w-8",children:[e.jsx(Cs,{src:(h=s.profile)==null?void 0:h.avatar_url}),e.jsx(Ke,{children:m[0].toUpperCase()})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:m}),t&&e.jsx(le,{variant:"outline",className:"text-xs h-5",children:"You"})]}),((x=s.profile)==null?void 0:x.status)&&e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.profile.status})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(le,{variant:i(r),className:"text-xs h-5 gap-1",children:[d(r),r]}),a&&!t&&e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:[e.jsx(Rs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Member options"})]})}),e.jsxs(Be,{align:"end",children:[r==="member"&&e.jsxs(e.Fragment,{children:[e.jsxs(Q,{onClick:l,children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),"Promote to Moderator"]}),e.jsx(pe,{})]}),r==="moderator"&&e.jsxs(e.Fragment,{children:[e.jsxs(Q,{onClick:l,children:[e.jsx(Es,{className:"h-4 w-4 mr-2"}),"Promote to Admin"]}),e.jsx(Q,{onClick:o,children:"Demote to Member"}),e.jsx(pe,{})]}),r==="admin"&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{onClick:o,children:"Demote to Member"}),e.jsx(pe,{})]}),e.jsxs(Q,{onClick:c,className:"text-destructive focus:text-destructive",children:[e.jsx(nt,{className:"h-4 w-4 mr-2"}),"Remove Member"]})]})]})]})]})},Zi=({open:s,onOpenChange:t,onRoomCreated:a})=>{const{createRoom:c}=ns(),[l,o]=n.useState(""),[d,i]=n.useState(""),[m,r]=n.useState("private"),[u,f]=n.useState(!1),[h,x]=n.useState("60"),[v,j]=n.useState(!1),y=async p=>{if(p.preventDefault(),!l.trim())return;j(!0);const g=await c(l,d,m,u,parseInt(h));j(!1),g&&(a==null||a(g),t(!1),k())},k=()=>{o(""),i(""),r("private"),f(!1),x("60")};return e.jsx(vs,{open:s,onOpenChange:t,children:e.jsxs(js,{className:"sm:max-w-[425px]",children:[e.jsxs(ws,{children:[e.jsxs(bs,{className:"flex items-center gap-2",children:[m==="private"?e.jsx(Ce,{className:"h-5 w-5"}):e.jsx(Ne,{className:"h-5 w-5"}),"Create ",u?"Temporary":""," Room"]}),e.jsx(Ns,{children:u?"This room will be automatically deleted when it expires.":"Create a private room for secure conversations."})]}),e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"name",children:"Room Name"}),e.jsx(ce,{id:"name",placeholder:"Enter room name",value:l,onChange:p=>o(p.target.value),required:!0,maxLength:50,"aria-describedby":"name-hint"}),e.jsxs("p",{id:"name-hint",className:"text-xs text-muted-foreground",children:[l.length,"/50 characters"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"description",children:"Description (optional)"}),e.jsx(mt,{id:"description",placeholder:"What's this room about?",value:d,onChange:p=>i(p.target.value),maxLength:200,rows:2})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(X,{children:"Room Type"}),e.jsxs(pt,{value:m,onValueChange:p=>r(p),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gs,{value:"private",id:"private"}),e.jsxs(X,{htmlFor:"private",className:"flex items-center gap-1 cursor-pointer",children:[e.jsx(Ce,{className:"h-4 w-4"}),"Private"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gs,{value:"group",id:"group"}),e.jsxs(X,{htmlFor:"group",className:"flex items-center gap-1 cursor-pointer",children:[e.jsx(Ne,{className:"h-4 w-4"}),"Group"]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(it,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(X,{htmlFor:"temporary",className:"cursor-pointer",children:"Temporary Room"})]}),e.jsx(Ze,{id:"temporary",checked:u,onCheckedChange:f,"aria-describedby":"temporary-hint"})]}),u&&e.jsx("p",{id:"temporary-hint",className:"text-xs text-muted-foreground -mt-2",children:"Room will be deleted automatically after expiration"}),u&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"expires",children:"Expires In"}),e.jsxs(Yt,{value:h,onValueChange:x,children:[e.jsx(Kt,{id:"expires",children:e.jsx(Qt,{})}),e.jsxs(Xt,{children:[e.jsx(Se,{value:"15",children:"15 minutes"}),e.jsx(Se,{value:"30",children:"30 minutes"}),e.jsx(Se,{value:"60",children:"1 hour"}),e.jsx(Se,{value:"180",children:"3 hours"}),e.jsx(Se,{value:"360",children:"6 hours"}),e.jsx(Se,{value:"720",children:"12 hours"}),e.jsx(Se,{value:"1440",children:"24 hours"})]})]})]}),e.jsxs(ks,{children:[e.jsx(_,{type:"button",variant:"outline",onClick:()=>t(!1),children:"Cancel"}),e.jsxs(_,{type:"submit",disabled:v||!l.trim(),children:[v&&e.jsx(Le,{className:"mr-2 h-4 w-4 animate-spin"}),"Create Room"]})]})]})]})})},eo=({onSelectRoom:s,selectedRoomId:t})=>{const{user:a}=J(),{rooms:c,isLoading:l,deleteRoom:o,leaveRoom:d,isRoomAdmin:i}=ns(),[m,r]=n.useState(!1);if(!a)return e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(Ce,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Login to access private rooms"})]});const u=c.filter(h=>!h.is_temporary),f=c.filter(h=>h.is_temporary);return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-border",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Private Rooms"}),e.jsx(_,{size:"sm",variant:"ghost",onClick:()=>r(!0),"aria-label":"Create new room",children:e.jsx(Rr,{className:"h-4 w-4"})})]}),e.jsx(be,{className:"flex-1",children:l?e.jsx("div",{className:"p-4 text-center text-muted-foreground text-sm",children:"Loading rooms..."}):c.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(Te,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No rooms yet"}),e.jsx(_,{size:"sm",variant:"link",onClick:()=>r(!0),className:"mt-2",children:"Create your first room"})]}):e.jsxs("div",{className:"p-2 space-y-4",children:[u.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground px-2 mb-2",children:"Saved Rooms"}),e.jsx("div",{className:"space-y-1",children:u.map(h=>e.jsx(Lt,{room:h,isSelected:t===h.id,isAdmin:i(h.id),onSelect:()=>s==null?void 0:s(h),onDelete:()=>o(h.id),onLeave:()=>d(h.id)},h.id))})]}),f.length>0&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground px-2 mb-2 flex items-center gap-1",children:[e.jsx(it,{className:"h-3 w-3"}),"Temporary Rooms"]}),e.jsx("div",{className:"space-y-1",children:f.map(h=>e.jsx(Lt,{room:h,isSelected:t===h.id,isAdmin:i(h.id),onSelect:()=>s==null?void 0:s(h),onDelete:()=>o(h.id),onLeave:()=>d(h.id)},h.id))})]})]})}),e.jsx(Zi,{open:m,onOpenChange:r,onRoomCreated:s})]})},Lt=({room:s,isSelected:t,isAdmin:a,onSelect:c,onDelete:l,onLeave:o})=>{const d=s.expires_at?new Date(s.expires_at):null,i=d?fs(d,{addSuffix:!0}):null;return e.jsxs("div",{className:`
        flex items-center justify-between p-2 rounded-lg cursor-pointer transition-colors
        ${t?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"}
      `,onClick:c,role:"button",tabIndex:0,"aria-selected":t,onKeyDown:m=>m.key==="Enter"&&c(),children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[s.room_type==="group"?e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}):e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),s.is_temporary&&i&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(it,{className:"h-3 w-3"}),"Expires ",i]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[s.is_temporary&&e.jsx(le,{variant:"outline",className:"text-xs h-5",children:"Temp"}),e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,onClick:m=>m.stopPropagation(),children:e.jsxs(_,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:[e.jsx(Rs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Room options"})]})}),e.jsx(Be,{align:"end",children:a?e.jsxs(Q,{onClick:m=>{m.stopPropagation(),l()},className:"text-destructive focus:text-destructive",children:[e.jsx(nt,{className:"h-4 w-4 mr-2"}),"Delete Room"]}):e.jsxs(Q,{onClick:m=>{m.stopPropagation(),o()},children:[e.jsx(Zt,{className:"h-4 w-4 mr-2"}),"Leave Room"]})})]})]})]})},so=({onStartChat:s})=>{const{user:t}=J(),{contacts:a,isLoading:c,addContact:l,removeContact:o,searchUsers:d}=Zs(),[i,m]=n.useState(!1),[r,u]=n.useState(""),[f,h]=n.useState([]),[x,v]=n.useState(!1),[j,y]=n.useState(!1),k=async g=>{if(u(g),g.trim().length<2){h([]);return}v(!0);const b=await d(g);h(b),v(!1)},p=async g=>{y(!0);const b=await l(g);y(!1),b&&(u(""),h([]))};return t?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-border",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Contacts"}),e.jsx(_,{size:"sm",variant:"ghost",onClick:()=>m(!0),"aria-label":"Add contact",children:e.jsx(Ie,{className:"h-4 w-4"})})]}),e.jsx(be,{className:"flex-1",children:c?e.jsx("div",{className:"p-4 text-center text-muted-foreground text-sm",children:"Loading contacts..."}):a.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(Zr,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No contacts yet"}),e.jsx(_,{size:"sm",variant:"link",onClick:()=>m(!0),className:"mt-2",children:"Add your first contact"})]}):e.jsx("div",{className:"p-2 space-y-1",children:a.map(g=>e.jsx(to,{contact:g,onRemove:()=>o(g.id),onStartChat:()=>{var b,N;return s==null?void 0:s(g.contact_user_id,g.nickname||((b=g.contact_profile)==null?void 0:b.display_name)||((N=g.contact_profile)==null?void 0:N.username)||"User")}},g.id))})}),e.jsx(vs,{open:i,onOpenChange:m,children:e.jsxs(js,{className:"sm:max-w-[400px]",children:[e.jsxs(ws,{children:[e.jsxs(bs,{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5"}),"Add Contact"]}),e.jsx(Ns,{children:"Search for users to add to your contacts"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Search by username...",value:r,onChange:g=>k(g.target.value),className:"pl-10","aria-label":"Search users"})]}),e.jsx("div",{className:"min-h-[200px] max-h-[300px] overflow-y-auto",children:x?e.jsx("div",{className:"flex items-center justify-center h-20",children:e.jsx(Le,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):f.length>0?e.jsx("div",{className:"space-y-2",children:f.map(g=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ye,{className:"h-8 w-8",children:[e.jsx(Cs,{src:g.avatar_url}),e.jsx(Ke,{children:(g.display_name||g.username||"U")[0].toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:g.display_name||g.username}),g.username&&g.display_name&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",g.username]})]})]}),e.jsx(_,{size:"sm",variant:"outline",onClick:()=>p(g.user_id),disabled:j,children:j?e.jsx(Le,{className:"h-4 w-4 animate-spin"}):e.jsx(Ie,{className:"h-4 w-4"})})]},g.user_id))}):r.length>=2?e.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-sm",children:"No users found"}):e.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-sm",children:"Enter at least 2 characters to search"})})]}),e.jsx(ks,{children:e.jsx(_,{variant:"outline",onClick:()=>m(!1),children:"Close"})})]})})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(Ne,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Login to access your contacts"})]})},to=({contact:s,onRemove:t,onStartChat:a})=>{var l,o,d,i;const c=s.nickname||((l=s.contact_profile)==null?void 0:l.display_name)||((o=s.contact_profile)==null?void 0:o.username)||"User";return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(Ye,{className:"h-8 w-8",children:[e.jsx(Cs,{src:(d=s.contact_profile)==null?void 0:d.avatar_url}),e.jsx(Ke,{children:c[0].toUpperCase()})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:c}),((i=s.contact_profile)==null?void 0:i.status)&&e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.contact_profile.status})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:a,"aria-label":`Chat with ${c}`,children:e.jsx(Te,{className:"h-4 w-4"})}),e.jsxs(ze,{children:[e.jsx($e,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:[e.jsx(Rs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Contact options"})]})}),e.jsxs(Be,{align:"end",children:[e.jsxs(Q,{onClick:a,children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),"Send Message"]}),e.jsxs(Q,{onClick:t,className:"text-destructive focus:text-destructive",children:[e.jsx(nt,{className:"h-4 w-4 mr-2"}),"Remove Contact"]})]})]})]})]})},ao=async(s,t,a,c,l)=>{const o=l.filter(d=>d.user_id&&d.user_id!==c&&d.username&&d.display_name);if(o.length===0)return{success:!0,processed_mentions:0};try{return console.log("üîî Mention notifications would be sent for:",{messageId:s,messageContent:t.slice(0,100)+(t.length>100?"...":""),senderName:a,senderId:c,mentions:o}),{success:!0,processed_mentions:o.length}}catch(d){return console.error("Error sending mention notifications:",d),{success:!1,error:d.message,processed_mentions:0}}},So=()=>{const{user:s}=J(),{toast:t}=ee(),{reactions:a,toggleReaction:c}=on(),{submitReport:l}=ln(),{editMessage:o,deleteMessage:d}=cn(),{replyingTo:i,startReply:m,cancelReply:r,sendReply:u,loadThreadReplies:f,getThreadReplies:h}=dn(),{logSecurityEvent:x}=aa();vn();const{sendMessageToBot:v,isBotMention:j}=As(),[y,k]=n.useState(!1),[p,g]=n.useState(!1),[b,N]=n.useState(!1),[C,I]=n.useState(!1),[U,q]=n.useState(!1),[Y,ie]=n.useState([]),[me,he]=n.useState(""),[oe,H]=n.useState([]),[se,xe]=n.useState(""),[ue,Ue]=n.useState([]),[fe,_e]=n.useState(null),[w,L]=n.useState(null),[$,M]=n.useState("users"),[F,W]=n.useState(""),[ae,Z]=n.useState(!1),[ge,os]=n.useState(new Set),[Xe,Fe]=n.useState(!0),[Oe,ls]=n.useState(!1),Me=n.useRef(null),Ae=50,A=async()=>{let S=E.from("messages").select("*").eq("is_deleted",!1);w?S=S.eq("channel_id",w.id):S=S.is("channel_id",null);const{data:R,error:T}=await S.order("created_at",{ascending:!1}).limit(Ae);if(!T&&R){R.length<Ae&&Fe(!1);const B=R.map(z=>({...z,mentions:Array.isArray(z.mentions)?z.mentions:[]}));ie(B.reverse())}},D=async()=>{if(Oe||!Xe||Y.length===0)return;ls(!0);const S=Y[0];try{let R=E.from("messages").select("*").eq("is_deleted",!1).lt("created_at",S.created_at);w?R=R.eq("channel_id",w.id):R=R.is("channel_id",null);const{data:T,error:B}=await R.order("created_at",{ascending:!1}).limit(Ae);if(B)throw B;if(T){T.length<Ae&&Fe(!1);const z=T.map(P=>({...P,mentions:Array.isArray(P.mentions)?P.mentions:[]}));ie(P=>[...z.reverse(),...P])}}catch(R){console.error("Error loading more messages:",R),t({title:"Error",description:"Failed to load older messages",variant:"destructive"})}finally{ls(!1)}};n.useEffect(()=>{const S=new IntersectionObserver(R=>{R[0].isIntersecting&&Xe&&!Oe&&D()},{threshold:.5});return Me.current&&S.observe(Me.current),()=>S.disconnect()},[Xe,Oe,Y]);const K=n.useRef(null),O=n.useRef(null),te=n.useRef(0);n.useEffect(()=>{localStorage.getItem("ageVerified")==="true"&&k(!0)},[]),n.useEffect(()=>{if(y&&!s&&!se){const S=an();xe(S)}s&&se&&(nn(),xe(""))},[y,s,se]),n.useEffect(()=>{if(!y)return;Fe(!0),A();const S=w?`room-messages-${w.id}`:"public-messages",R=E.channel(S,{config:{broadcast:{self:!1},presence:{key:"messages"}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:w?`channel_id=eq.${w.id}`:"channel_id=is.null"},T=>{try{console.log("‚úÖ New message received via realtime:",T.new),ie(B=>{if(B.some(re=>re.id===T.new.id))return console.log("üìù Message already exists, skipping duplicate"),B;const P={...T.new,mentions:Array.isArray(T.new.mentions)?T.new.mentions:[]};return[...B,P]})}catch(B){console.error("‚ùå Error processing new message:",B)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},T=>{console.log("‚úèÔ∏è Message updated via realtime:",T.new),ie(B=>B.map(z=>z.id===T.new.id?{...T.new,mentions:Array.isArray(T.new.mentions)?T.new.mentions:[]}:z))}).subscribe(T=>{console.log("üì° Messages subscription status:",T),T==="SUBSCRIBED"?console.log("‚úÖ Successfully subscribed to real-time messages"):T==="CHANNEL_ERROR"?(console.error("‚ùå Channel subscription error - attempting reconnection"),setTimeout(()=>{R.state==="errored"&&R.unsubscribe()},2e3)):T==="TIMED_OUT"?console.error("‚è∞ Channel subscription timed out"):T==="CLOSED"&&console.log("üì¥ Channel subscription closed")});return()=>{E.removeChannel(R)}},[y,w]),n.useEffect(()=>y?(O.current&&(E.removeChannel(O.current),O.current=null),(()=>{var ye;const R=s,T=se;if(!R&&!T)return;const B=R?((ye=R.user_metadata)==null?void 0:ye.name)||R.email:T,z=R?R.id:`${T}_${Date.now()}`,P=!!R,re=E.channel("online-users",{config:{presence:{key:z}}});re.on("presence",{event:"sync"},()=>{const ve=re.presenceState(),De=[];for(const ds in ve)ve[ds].forEach(vt=>{De.push({name:vt.name,isMember:vt.isMember,key:ds})});Ue(De)}).subscribe(ve=>{ve==="SUBSCRIBED"&&re.track({name:B,isMember:P})}),O.current=re})(),()=>{O.current&&(E.removeChannel(O.current),O.current=null)}):void 0,[y,s,se]),n.useEffect(()=>{var S;me===""&&((S=K.current)==null||S.scrollIntoView({behavior:"smooth"}))},[Y,me]),n.useEffect(()=>{var R;const S=()=>{setTimeout(()=>{var T;(T=K.current)==null||T.scrollIntoView({behavior:"smooth"})},100)};return(R=window.visualViewport)==null||R.addEventListener("resize",S),()=>{var T;return(T=window.visualViewport)==null?void 0:T.removeEventListener("resize",S)}},[]),n.useEffect(()=>{if(!y)return;if(!me){H([]);return}const R=setTimeout(async()=>{const{data:T,error:B}=await E.from("messages").select("*").ilike("content",`%${me}%`).order("created_at",{ascending:!0});if(!B){const z=(T||[]).map(P=>({...P,mentions:Array.isArray(P.mentions)?P.mentions:[]}));H(z)}},300);return()=>clearTimeout(R)},[me,y]);const cs=async(S,R=[])=>{var z;const T=Date.now();if(T-te.current<1e3){t({title:"Slow down!",description:"Please wait a moment before sending another message.",variant:"destructive"});return}te.current=T;const B=s?((z=s.user_metadata)==null?void 0:z.name)||s.email:se;if(j(S,R)){console.log("ü§ñ Bot mention detected, sending to bot..."),t({title:"Sending message to AI...",description:"The bot is processing your request."});const P=await v(S,B,R,(w==null?void 0:w.id)||null);if(P.success&&P.botResponse){console.log("‚úÖ Bot responded successfully:",{response:P.botResponse,messageId:P.messageId,savedToDatabase:P.savedToDatabase}),P.savedToDatabase?t({title:"AI response received!",description:"The bot has responded to your message.",variant:"default"}):t({title:"Partial bot response",description:"Bot responded but the message may not be visible to all users.",variant:"destructive"});return}else{console.log("üî¥ Bot failed:",P.error),t({title:"Bot unavailable",description:P.error||"The AI bot is temporarily unavailable.",variant:"destructive"});return}}try{console.log("üì§ Sending message:",{content:S,senderName:B,sender_id:(s==null?void 0:s.id)||null,mentions:R,channel_id:(w==null?void 0:w.id)||null});const{data:P,error:re}=await E.from("messages").insert({content:S,sender_name:B,sender_id:(s==null?void 0:s.id)||null,mentions:R||[],channel_id:(w==null?void 0:w.id)||null,user_id:(s==null?void 0:s.id)||null}).select().single();if(re)console.error("‚ùå Error sending message:",re);else if(console.log("‚úÖ Message sent successfully:",P),ie(ye=>{if(ye.some(ds=>ds.id===P.id))return ye;const De={...P,mentions:Array.isArray(P.mentions)?P.mentions:[]};return[...ye,De]}),R&&R.length>0){const ye=R.filter(ve=>{var De;return((De=ve.username)==null?void 0:De.toLowerCase())!=="bot"});ye.length>0&&ao(P.id,S,B,(s==null?void 0:s.id)||null,ye).catch(ve=>console.error("Failed to send mention notifications:",ve))}re&&(re.message.includes("too long")?t({title:"Message too long",description:"Please keep your message under 1000 characters.",variant:"destructive"}):re.message.includes("prohibited content")?t({title:"Message blocked",description:"Your message contains prohibited content.",variant:"destructive"}):re.message.includes("rate limit")?t({title:"Rate limited",description:"You're sending messages too quickly. Please slow down.",variant:"destructive"}):t({title:"Failed to send message",description:re.message,variant:"destructive"}))}catch{t({title:"Network error",description:"Failed to send message. Please check your connection.",variant:"destructive"})}},tr=(S,R,T)=>{gt(S)},gt=S=>{W(S),Z(!0),I(!1)},ar=()=>{ae&&(W(""),Z(!1))},yt=(S,R)=>{if(!s){t({title:"Login required",description:"Please log in to send private messages.",variant:"destructive"}),g(!0);return}_e({id:S,name:R})},rr=async S=>{if(!O.current)return;const R=ta(S);if(!R.valid){t({title:"Invalid name",description:R.error||"Please choose a different name.",variant:"destructive"});return}try{x("guest_name_change",{oldName:se,newName:R.sanitized,timestamp:new Date().toISOString()}),await O.current.untrack(),await O.current.track({name:R.sanitized,isMember:!1}),xe(R.sanitized),rn(R.sanitized)}catch(T){console.error("Failed to change name:",T),t({title:"Failed to change name",description:"Please try again.",variant:"destructive"})}},nr=()=>{try{const S=JSON.stringify(Y,null,2),R="data:application/json;charset=utf-8,"+encodeURIComponent(S),T=`chat-export-${new Date().toISOString().slice(0,10)}.json`,B=document.createElement("a");B.setAttribute("href",R),B.setAttribute("download",T),B.click(),t({title:"Chat Exported",description:"Your chat history has been downloaded."})}catch{t({title:"Export failed",description:"Could not export chat history.",variant:"destructive"})}},ir=(S,R)=>{c(S,R)},or=(S,R,T)=>{l(S,R,T)},lr=async(S,R)=>{const T=Y.find(z=>z.id===S);ie(z=>z.map(P=>P.id===S?{...P,content:R,edited_at:new Date().toISOString()}:P)),await o(S,R)||(t({title:"Edit failed",description:"Failed to save changes. Reverting...",variant:"destructive"}),T&&ie(z=>z.map(P=>P.id===S?T:P)))},cr=async S=>{const R=Y.find(B=>B.id===S);ie(B=>B.map(z=>z.id===S?{...z,is_deleted:!0,content:"This message was deleted"}:z)),await d(S)||(t({title:"Delete failed",description:"Failed to delete message. Reverting...",variant:"destructive"}),R&&ie(B=>B.map(z=>z.id===S?R:z)))},Ts=me.length>0,dr=Ts?oe:Y;return y?e.jsxs("div",{className:"h-screen flex flex-col bg-chat-background",children:[e.jsx(Cn,{searchQuery:me,onSearchChange:he,onLoginClick:()=>g(!0),onDonateClick:()=>N(!0),onOpenPrivateChat:yt,onShowBookmarks:()=>q(!0),onExportChat:nr,currentRoom:w,onRoomSelect:L}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:`
          fixed inset-0 bg-black/50 z-40 transition-opacity md:hidden
          ${C?"opacity-100":"opacity-0 pointer-events-none"}
        `,onClick:()=>I(!1)}),e.jsx("div",{className:`
          fixed left-0 top-0 h-full z-50 transition-transform md:relative md:translate-x-0 md:z-auto
          ${C?"translate-x-0":"-translate-x-full"}
        `,children:e.jsxs(_s,{value:$,onValueChange:S=>M(S),className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-3 border-b border-border",children:e.jsxs(Ss,{className:"grid w-full grid-cols-3",children:[e.jsxs(je,{value:"users",className:"flex items-center gap-1.5 text-xs",children:[e.jsx(Ne,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Users"})]}),e.jsxs(je,{value:"rooms",className:"flex items-center gap-1.5 text-xs",children:[e.jsx(Te,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Rooms"})]}),e.jsxs(je,{value:"contacts",className:"flex items-center gap-1.5 text-xs",children:[e.jsx(Ie,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Contacts"})]})]})}),e.jsx(we,{value:"users",className:"flex-1 overflow-hidden m-0",children:e.jsx(En,{users:ue,guestName:se,onUserClick:tr,onGuestNameChange:rr,onMentionUser:gt})}),e.jsx(we,{value:"rooms",className:"flex-1 overflow-hidden m-0",children:e.jsx(eo,{onSelectRoom:S=>{L(S),I(!1)},selectedRoomId:w==null?void 0:w.id})}),e.jsx(we,{value:"contacts",className:"flex-1 overflow-hidden m-0",children:e.jsx(so,{onStartChat:(S,R)=>{_e({id:S,name:R}),I(!1)}})})]})}),e.jsxs("main",{className:"flex-1 flex flex-col relative",children:[e.jsx("button",{onClick:()=>I(!C),className:"md:hidden absolute top-4 left-4 z-10 bg-primary text-primary-foreground rounded-full p-2 shadow-lg",children:e.jsx(Ne,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pt-16 md:pt-4 space-y-1",children:[e.jsx("div",{ref:Me,className:"h-4 w-full flex justify-center items-center py-2",children:Oe&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-primary border-t-transparent"})}),Ts&&e.jsxs("div",{className:"mb-4 p-3 bg-muted rounded-lg animate-fade-in",children:[e.jsxs("h3",{className:"font-semibold text-sm mb-2",children:["Search Results (",oe.length,")"]}),oe.length===0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:['No messages found for "',me,'"']})]}),dr.map(S=>{const R=s?S.sender_id===s.id:S.sender_name===se,T=h(S.id),B=ge.has(S.id);return e.jsxs("div",{className:"group",children:[e.jsx(ci,{message:S,isOwn:R,guestName:se,reactions:a[S.id],onReact:ir,onReport:or,onEdit:lr,onDelete:cr,onReply:m,onPrivateMessage:yt}),e.jsx("div",{className:"ml-10 mb-2",children:e.jsx(Vi,{messageId:S.id,replyCount:S.reply_count||0,onStartReply:m,onToggleThread:z=>{B?os(P=>{const re=new Set(P);return re.delete(z),re}):(os(P=>new Set(P).add(z)),f(z))},isThreadOpen:B})}),B&&T.length>0&&e.jsx("div",{className:"ml-10 space-y-2 mb-4",children:T.map(z=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium",children:z.username}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(z.created_at).toLocaleTimeString()})]}),e.jsx("div",{className:"pl-4 border-l-2 border-muted",children:z.content})]},z.id))}),i===S.id&&e.jsx("div",{className:"ml-10 mb-4",children:e.jsx(Gi,{parentMessageId:S.id,onSendReply:u,onCancel:r})})]},S.id)}),e.jsx("div",{ref:K})]}),!Ts&&e.jsx(qi,{onSendMessage:cs,placeholder:"Type a message...",onlineUsers:ue,mentionToAdd:F,onMentionAdded:ar})]}),s&&w&&w.room_type==="group"&&e.jsx("div",{className:"hidden lg:block w-64 border-l border-border",children:e.jsx(Xi,{roomId:w.id,roomName:w.name})})]}),p&&e.jsx(Wi,{onClose:()=>g(!1)}),b&&e.jsx(Yi,{onClose:()=>N(!1)}),fe&&e.jsx(Hi,{partner:fe,onClose:()=>_e(null)}),U&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsx(Ki,{onClose:()=>q(!1),onMessageClick:S=>{const R=document.querySelector(`[data-message-id="${S}"]`);R&&(R.scrollIntoView({behavior:"smooth",block:"center"}),R.classList.add("ring-2","ring-primary","ring-opacity-50"),setTimeout(()=>{R.classList.remove("ring-2","ring-primary","ring-opacity-50")},2e3)),q(!1)}})})]}):e.jsx(jn,{onConfirm:()=>k(!0)})};export{So as default};
